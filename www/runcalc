<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Activity Tracker</title>
    <link href="style_280218.css" type="text/css" rel="stylesheet" />
	<link href="css/tablesorter.pager.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.structure.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.theme.min.css" type="text/css" rel="stylesheet" />
    <link rel="icon" href="tab_icon.png">
    <script src="jquery-3.2.1.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="js/jquery.tablesorter.js"></script>
    <script src="js/jquery.tablesorter.widgets.js"></script>
    <script src="js/parsers/parser-ipv6.js"></script>
    <script src="js/jquery.metadata.js"></script>
	<script src="js/jquery.tablesorter.pager.js"></script>
	<script src="js/pager-custom-controls.js"></script>
	
	<script type="text/javascript" src="fusioncharts.js"></script>
	<script type="text/javascript" src="fusioncharts-jquery-plugin.min.js"></script>
	
	<style>
		#sortable li {
			display: inline-block;
		}
		#dashSort li {
			display: inline-block;
		}
	</style>

    <script>
	
		var compactDate = false;
		
		function vald(ch, allowWh) {
			if (ch == ' ') {
				return allowWh;
			}
			if (ch == '_') {
				return true;
			}
			if (ch >= 'a' && ch <= 'z') {
				return true;
			}
			if (ch >= 'A' && ch <= 'Z') {
				return true;
			}
			if (ch >= '0' && ch <= '9') {
				return true;
			}
			return false;
		}
		
		function validateDashName(dash) {
			for (i = 0; i < dash.length; ++i) {
				if (!vald(dash.charAt(i), true)) {
					return false;
				}
			}
			return true;
		}
		
		function validatePresetName(preset) {
			for (i = 0; i < preset.length; ++i) {
				if (!vald(preset.charAt(i), false)) {
					return false;
				}
			}
			return true;
		}
		
        function getOption(val, current) {
            return '<option value="' + val + '"' + (current == val ? ' selected>' : '>') + val + '</option>';
        }

        function colorDiff(diff) {
            c = diff.charAt(0);
            if (c == '+') {
                return '<span class="red">' + diff + '</span>';
            }
            if (c == '-') {
                return '<span class="green">' + diff + '</span>';
            }
            return diff;
        }

        function valTime(time) {
            res = time.split(":");
            if (res.length == 2) {
                return 60 * parseInt(res[0]) + parseInt(res[1]);
            }
            return 3600 * parseInt(res[0]) + 60 * parseInt(res[1]) + parseInt(res[2]);
        }

        function comp(t1, t2, tt) {
            if (t1 < t2) {
                return '<span class="green">' + tt + '</span>';
            }
            if (t1 == t2) {
                return tt;
            }
            return '<span class="red">' + tt + '</span>';
        }

        function compGr(t1, t2) {
            if (t1 > t2) {
                return '<span class="green">' + t1 + '</span>';
            }
            if (t1 == t2) {
                return t1;
            }
            return '<span class="red">' + t1 + '</span>';
        }

        function comp2(t1, t2) {
            return comp(parseFloat(t2.replace(',', '.')), parseFloat(t1.replace(',', '.')), t1);
        }

        function colorDiff1(tt1, tt2) {
            t1 = valTime(tt1);
            t2 = valTime(tt2);
            return comp(t1, t2, tt1);
        }

        function formatEle(gain, loss) {
            res = '-';
            if (gain > 0 && loss > 0) {
                res = '<span class="green">+' + gain + '</span>/<span class="red">-' + loss + '</span>';
            } else if (gain > 0) {
                res = '<span class="green">+' + gain + '</span>';
            } else if (loss > 0) {
                res = '<span class="red">-' + loss + '</span>';
            }
            return res;
        }

        function formatEleDiff(diff) {
            if (diff == 0) {
                return '0';
            }
            if (diff > 0) {
                return '<span class="green">+' + diff + '</span>';
            }
            return '<span class="red">' + diff + '</span>';
        }

        function round(point) {
            if (Math.abs(point - Math.round(point)) < 1e-3) {
                return Math.round(point);
            }
            return point;
        }
		
		function changeDash(alias, activity, dashboard) {
			if (dashboard == '') {
				return;
			}
			$.ajax({
                url: alias,
                headers: {
                    'Content-Type': 'application/txt',
                    'activity': activity,
                    'dashboard': dashboard,
                },
                method: 'POST',
                dataType: 'text',
                statusCode: {
                    200: function(resp) {
                        $('#infoDialog').html(resp);
                        $('#infoDialog').dialog('option', 'title', 'Status');
                        $('#infoDialog').dialog('open');
                    },
                    401: function(resp) {
                        $('#infoDialog').html('Please sign in!');
                        $('#infoDialog').dialog('option', 'title', 'Not authorized');
                        $('#infoDialog').dialog('open');
                    }
                }
            });
		}

        function initDialogs() {
			$('#createDashboard').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Create": function() {
						cdName = $('#cdName').val();
						$.ajax({
                            url: 'addDash',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': encodeURIComponent(cdName)
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									initDashboards(true);
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 200
            });
			$('#renameDashboard').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Rename": function() {
						var newName = $('#newDashName').val();
						$.ajax({
                            url: 'renameDash',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': encodeURIComponent($('.selectedDash').attr('name')),
								'newName': encodeURIComponent(newName)
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									initDashboards(true);
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 200
            });
			$('#removeDashboard').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Remove": function() {
						$.ajax({
                            url: 'removeDash',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': encodeURIComponent($('.selectedDash').attr('name'))
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									initDashboards(true);
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 200
            });
            $('#infoDialog').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "OK": function() {
                        $(this).dialog("close");
                    }
                },
                width: 300,
                height: 200
            });
			$('#confirmDialogDash').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Yes": function() {
						elements = '';
						$("#dashSort li").each(function(idx, li) {
							elements += encodeURIComponent($(li).text()) + '|||';
						});
						$.ajax({
							url: 'saveDashOrder',
							headers: {
								'Content-Type': 'application/json',
								'elements': elements
							},
							method: 'POST',
							dataType: 'text',
							statusCode: {
								200: function(resp) {
									$('#infoDialog').html(resp);
									$('#infoDialog').dialog('option', 'title', 'Status');
									$('#infoDialog').dialog('open');
								},
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
									$('#infoDialog').dialog('option', 'title', 'Not authorized');
									$('#infoDialog').dialog('open');
								}
							}
						});
                        $(this).dialog("close");
                    },
					"No": function() {
                        $(this).dialog("close");
                    }
                },
                width: 300,
                height: 200
            });
			$('#confirmDialogPresets').dialog({
				autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
					"Yes": function() {
						elements = '';
						$("#sortable li").each(function(idx, li) {
							elements += $(li).text() + '|||';
						});
						$.ajax({
							url: 'savePresetOrder',
							headers: {
								'Content-Type': 'application/json',
								'elements': elements
							},
							method: 'POST',
							dataType: 'text',
							statusCode: {
								200: function(resp) {
									$('#infoDialog').html(resp);
									$('#infoDialog').dialog('option', 'title', 'Status');
									$('#infoDialog').dialog('open');
								},
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
									$('#infoDialog').dialog('option', 'title', 'Not authorized');
									$('#infoDialog').dialog('open');
								}
							}
						});
                        $(this).dialog("close");
                    },
					"No": function() {
                        $(this).dialog("close");
                    }
                },
                width: 300,
                height: 200
			});
			$('#rescanDialog').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Rescan": function() {
                        $.ajax({
						url: 'rescanActivities',
						method: 'POST',
						dataType: 'json',
						statusCode: {
                        200: function(data) {
                            getBest();
                            fetch(true);
                            $('#infoDialog').html('Rescan completed!');
                            $('#infoDialog').dialog('option', 'title', 'Action finished');
                            $('#infoDialog').dialog('open');
						},
						401: function(resp) {
							$('#infoDialog').html('Please sign in!');
							$('#infoDialog').dialog('option', 'title', 'Not authorized');
							$('#infoDialog').dialog('open');
							}
						}
						});
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 300,
                height: 200
            });
            $('#login').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Login": function() {
                        $.ajax({
                            url: 'login',
                            headers: {
                                'Content-Type': 'application/json',
                                'User': $('#loginUser').val(),
                                'Password': $('#loginPassword').val()
                            },
                            method: 'POST',
                            dataType: 'json',
                            statusCode: {
                                200: function(xhr) {
                                    $('#infoDialog').html('Logged in!');
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
                                    $('#loginButton').prop("disabled",true);
                                    $('#loginButton').text("Authorized");
									$('#loginButton').css({'cursor': 'default'});
                                },
                                401: function(xhr) {
                                    $('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
                                },
                                500: function(xhr) {
                                    $('#infoDialog').html('Internal server error :(');
                                    $('#infoDialog').dialog('option', 'title', 'Error');
                                    $('#infoDialog').dialog('open');
                                }
                            }
                        });
                        $(this).dialog("close");
                    },
                    "Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 250
            });
            $('#editable').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Revert modifications": function() {
                        $.ajax({
                            url: 'revert',
                            headers: {
                                'Content-Type': 'application/json',
                                'File': $('#editable').attr('genby')
                            },
                            method: 'POST',
                            dataType: 'json',
                            statusCode: {
                                200: function(xhr) {
									$('#infoDialog').html('Activity modified!');
									$('#infoDialog').dialog('option', 'title', 'Status');
									$('#infoDialog').dialog('open');
                                    getBest();
                                    fetch(true);
                                },
                                401: function(xhr) {
                                    $('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
                                },
                                400: function(xhr) {
                                    $('#infoDialog').html('Wrong data!');
                                    $('#infoDialog').dialog('option', 'title', 'Error');
                                    $('#infoDialog').dialog('open');
                                }
                            }
                        });
                        $(this).dialog("close");
                    },
                    "Modify": function() {
						dashAdd = encodeURIComponent($('#addToDash option:selected').val());
						dashRem = encodeURIComponent($('#remFromDash option:selected').val());
						changeDash('addToDash', $('#editable').attr('genby'), dashAdd);
						changeDash('removeFromDash', $('#editable').attr('genby'), dashRem);
                        $.ajax({
                            url: 'editActivity',
                            headers: {
                                'Content-Type': 'application/json',
                                'File': $('#editable').attr('genby'),
                                'Name': encodeURIComponent($('#chooseName').val()),
                                'Type': $('#chooseType').val(),
                                'actDist': $('#actDist').val(),
                                'actTime': $('#actTime').val(),
                                'actGain': $('#actGain').val(),
                                'actLoss': $('#actLoss').val(),
                                'garminLink': $('#chooseGarmin').val(),
                                'ccLink': $('#chooseCC').val(),
                                'photosLink': $('#choosePhotos').val()
                            },
                            method: 'POST',
                            dataType: 'json',
                            statusCode: {
                                200: function(xhr) {
									$('#infoDialog').html('Activity Modified!');
									$('#infoDialog').dialog('option', 'title', 'Status');
									$('#infoDialog').dialog('open');
                                    getBest();
                                    fetch(true);
                                },
                                401: function(xhr) {
                                    $('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
                                },
                                400: function(xhr) {
                                    $('#infoDialog').html('Wrong data!');
                                    $('#infoDialog').dialog('option', 'title', 'Error');
                                    $('#infoDialog').dialog('open');
                                }
                            }
                        });
                        $(this).dialog("close");
                    },
					"Cancel": function() {
						$(this).dialog("close");
					}
                },
				width: Math.min($(window).width() * 0.7, 600),
                height: Math.min($(window).height() * 0.85, 750),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 70,
                        "top": 140
                    });
                }
            });
            $('#removable').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Remove": function() {
                        $.ajax({
                            url: 'deleteActivity',
                            headers: {
                                'Content-Type': 'application/json',
                                'File': $('#removable').attr('genby')
                            },
                            method: 'POST',
                            dataType: 'json',
                            statusCode: {
                                200: function(xhr) {
									$('#infoDialog').html('Activity removed!');
									$('#infoDialog').dialog('option', 'title', 'Status');
									$('#infoDialog').dialog('open');
                                    getBest();
                                    fetch(true);
                                },
                                401: function(xhr) {
                                    $('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
                                },
                                400: function(xhr) {
                                    $('#infoDialog').html('Name must not be empty!');
                                    $('#infoDialog').dialog('option', 'title', 'Error');
                                    $('#infoDialog').dialog('open');
                                }
                            }
                        });
                        $(this).dialog("close");
                    },
					"Cancel": function() {
						$(this).dialog("close");
					}
                },
                width: Math.min($(window).width() * 0.4, 400),
                height: Math.min($(window).height() * 0.4, 300),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 70,
                        "top": 140
                    });
                }
            });
            $('#comparable').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Compare": function() {
                        $.ajax({
                            url: 'compare',
                            method: 'POST',
                            dataType: 'json',
                            headers: {
                                'Content-Type': 'application/json',
                                'file1': $('#comparable').attr('file1'),
                                'file2': $('#selectComp').find(':selected').attr('genby')
                            },
                            statusCode: {
                                200: function(data) {
                                    index = $('#selectComp option:selected').index() + 1;
                                    general = data['general'];
                                    times = data['times'];
                                    tt = '';
                                    $.each(times, function(i, sp) {
                                        tt += '<tr><td><strong>' + round(sp['point']) + '</strong></td><td>' + colorDiff1(sp['time1'], sp['time2']) + '</td><td>' + colorDiff1(sp['time2'], sp['time1']) + '</td><td>' + colorDiff(sp['currentDiff']) + '</td><td>' + colorDiff(sp['totalDiff']) + '</td></tr>';
                                    });
                                    $('#selectComp :nth-child(' + index + ')').prop('selected', true);
									f1 = $('#comparable').attr('file1');
									if (f1.endsWith(".gpx")) {
										f1 = f1.substring(0, f1.length - 4);
									}
									f2 = $('#selectComp').find(':selected').attr('genby');
									if (f2.endsWith(".gpx")) {
										f2 = f2.substring(0, f2.length - 4);
									}
                                    var extLinkComp = '<hr><a href="compare?a1=' + f1 + '&a2=' + f2 + '" target="_blank"><input class="hovs" type="image" src="extview-icon.png" width="60" height="60" /></a>';
                                    $('#compareResults').html(extLinkComp + '<hr><table class="highlightOnly"><thead><th>Stat</th><th>' + decodeURIComponent(general['name1']) + ' ' + general['date1'] + '</th><th>' + decodeURIComponent(general['name2']) + ' ' + general['date2'] + '</th></thead><tbody>' +
                                        '<tr><td>Date</td><td>' + general['date1'] + '</td><td>' + general['date2'] + '</td></tr><tr><td>Distance</td><td>' + comp2(general['dist1'], general['dist2']) + '</td><td>' + comp2(general['dist2'], general['dist1']) + '</td></tr>' +
                                        '<tr><td>Time</td><td>' + colorDiff1(general['time1'], general['time2']) + '</td><td>' + colorDiff1(general['time2'], general['time1']) + '</td></tr>' +
                                        '<tr><td>Speed</td><td>' + comp2(general['speed1'], general['speed2']) + '</td><td>' + comp2(general['speed2'], general['speed1']) + '</td></tr><tr><td>Elev gain</td><td>' + general['elePos1'] + '</td><td>' + general['elePos2'] + '</td></tr>' +
                                        '<tr><td>Elev loss</td><td>' + general['eleNeg1'] + '</td><td>' + general['eleNeg2'] + '</td></tr>' +
                                        '<tr><td>Running|>9km/h| time</td><td>' + colorDiff1(general['timeRunning1'], general['timeRunning2']) + '</td><td>' + colorDiff1(general['timeRunning2'], general['timeRunning1']) + '</td></tr>' +
                                        '<tr><td>Running|>9km/h| distance</td><td>' + comp2(general['distRunning1'], general['distRunning2']) + '</td><td>' + comp2(general['distRunning2'], general['distRunning1']) + '</td></tr>' +
                                        '<tr><td>Running|>9km/h| elev gain</td><td>' + compGr(general['eleRunningPos1'], general['eleRunningPos2']) + '</td><td>' + compGr(general['eleRunningPos2'], general['eleRunningPos1']) + '</td></tr>' +
                                        '<tr><td>Running|>9km/h| elev loss</td><td>' + general['eleRunningNeg1'] + '</td><td>' + general['eleRunningNeg2'] + '</td></tr>' + '</tbody></table>');
                                    $('#compareResults').append('<span class="highlight"><h2>Splits</h2><table><thead><th>Point(km)</th><th>' + decodeURIComponent(general['name1']) + ' ' + general['date1'] + '</th><th>' + decodeURIComponent(general['name2']) + ' ' + general['date2'] + '</th><th>Segment diff</th><th>Total diff</th></thead><tbody>' + tt + '</tbody></table></span>');
                                },
                                400: function(xhr) {
                                    $('#infoDialog').html('Activities may be removed :(');
                                    $('#infoDialog').dialog('option', 'title', 'Error');
                                    $('#infoDialog').dialog('open');
                                }
                            }
                        });
                    },
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(800, $(window).width() * 0.8),
                height: Math.min(800, $(window).height() * 0.8),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
            $('#bestSplits').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min($(window).width() * 0.85, 850),
                height: Math.min($(window).height() * 0.85, 800),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
            $('#mTotals').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(800, $(window).width() * 0.8),
                height: Math.min($(window).height() * 0.85, 900),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
			$('#wTotals').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(800, $(window).width() * 0.8),
                height: Math.min($(window).height() * 0.85, 900),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
			$('#typesDialog').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(900, $(window).width() * 0.85),
                height: Math.min($(window).height() * 0.7, 550),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
			$('#presetsDlg').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Save": function() {
						name = $('#newPresetName').val();
						period = $('input[name=selectPeriod]:checked').attr('id');
						ds = $('#dtStart').datepicker('getDate');
						de = $('#dtEnd').datepicker('getDate');
						nf = encodeURIComponent($('#searchName').val());
						if (!validatePresetName(name)) {
							$('#infoDialog').html('Preset name must only contain latin letters, digits and _');
							$('#infoDialog').dialog('option', 'title', 'Status');
							$('#infoDialog').dialog('open');
							$(this).dialog("close");
							return;
						}
						$.ajax({
                            url: 'saveFilter',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': name,
								'run': $('#checkbox-1').prop('checked'),
								'trail': $('#checkbox-2').prop('checked'),
								'uphill': $('#checkbox-3').prop('checked'),
								'hike': $('#checkbox-4').prop('checked'),
								'walk': $('#checkbox-5').prop('checked'),
								'other': $('#checkbox-6').prop('checked'),
								'dateOpt': parseInt(period[period.length - 1]) - 1,
								'startDate': ds ? (ds.getMonth() + 1) + '/' + ds.getDate() + '/' + ds.getFullYear() : '',
								'endDate': de ? (de.getMonth() + 1) + '/' + de.getDate() + '/' + de.getFullYear() : '',
								'pattern': nf,
								'dmin': $('#spinnerMin').val(),
								'dmax': $('#spinnerMax').val(),
								'dashboard': encodeURIComponent($('.selectedDash').attr('name'))
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
									getPresets();
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 200
            });
			$('#renamePresetDlg').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Rename": function() {
						$.ajax({
                            url: 'renameFilter',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': $('#selectPreset').find(':selected').val(),
								'newName': $('#setPresetName').val()
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
									getPresets();
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 250
            });
			$('#removePresetDlg').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Remove": function() {
						$.ajax({
                            url: 'removeFilter',
                            headers: {
                                'Content-Type': 'application/json',
                                'name': $('#selectPresetRem').find(':selected').val()
                            },
                            method: 'POST',
                            dataType: 'text',
                            statusCode: {
                                200: function(resp) {
									$('#infoDialog').html(resp);
                                    $('#infoDialog').dialog('option', 'title', 'Status');
                                    $('#infoDialog').dialog('open');
									getPresets();
                                },
								401: function(resp) {
									$('#infoDialog').html('Please sign in!');
                                    $('#infoDialog').dialog('option', 'title', 'Not authorized');
                                    $('#infoDialog').dialog('open');
								}
                            }
                        });
						$(this).dialog("close");
                    },
					"Cancel": function() {
                        $(this).dialog("close");
                    }
                },
                width: 450,
                height: 250
            });
        }

        function initSecondaryDialogs() {
            $('#overall').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(400),
                height: Math.min(450),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
            $('#bestOf').dialog({
                autoOpen: false,
                modal: true,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min(400),
                height: Math.min(600),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            });
        }
		
		function initPresets(presets) {
			allPresetsHtml = '<ul id="sortable">';
			$.each(presets, function(i, item) {
				name = decodeURIComponent(item['name']);
				allPresetsHtml += '<li class="presetButton" id="preset' + name + '">' + name + '</li>';
			});
			$('#allPresets').html(allPresetsHtml + '</ul>');
			$("#sortable").sortable();
			$("#sortable").disableSelection();
			$("#dashSort").sortable();
			$("#dashSort").disableSelection();
			$.each(presets, function(i, item) {
				name = decodeURIComponent(item['name']);
				$('#preset' + name).click(function() {
					if ($('#search').button("option", "disabled")) {
						return;
					}
					$(this).addClass('selectedDash');
					$('#searchName').val(decodeURIComponent(item['pattern']));
					for (i = 1; i < 7; ++i) {
						$('#checkbox-' + i).prop('checked', false).change();
					}
					if (item['run']) {
						$('#checkbox-1').prop('checked', true).change();
					}
					if (item['trail']) {
						$('#checkbox-2').prop('checked', true).change();
					}
					if (item['uphill']) {
						$('#checkbox-3').prop('checked', true).change();
					}
					if (item['hike']) {
						$('#checkbox-4').prop('checked', true).change();
					}
					if (item['walk']) {
						$('#checkbox-5').prop('checked', true).change();
					}
					if (item['other']) {
						$('#checkbox-6').prop('checked', true).change();
					}
					sd = item['startDate'];
					if (sd.length > 0) {
						si = sd.indexOf('/');
						if (si == -1) {
							$('#radio-' + (parseInt(sd) + 1)).prop('checked', true).change();
						} else {
							$('#radio-7').prop('checked', true).change();
							$('#dtStart').val(sd);
						}
					} else {
						$('#dtEnd').val('');
					}
					$('#dtEnd').val(item['endDate']);
					if (item['minDist'] > 0) {
						$('#spinnerMin').val(item['minDist']);
					} else {
						$('#spinnerMin').val('');
					}
					if (item['maxDist'] < 2147483647) {
						$('#spinnerMax').val(item['maxDist']);
					} else {
						$('#spinnerMax').val('');
					}
					fetchAfterDashClick = false;
					$('li[name="' + decodeURIComponent(item['dashboard']) + '"]').click();
					fetchAfterDashClick = true;
					$('#runs').hide();
					$('#ht').html('<div class="loader"></div>');
					$('#runs').trigger('pagerUpdate', 1);
					$('#runs').trigger('pageSize', 20);
					$('a').removeClass('current');
					$('#defPage').addClass('current');
					$('#pagerMenu').hide();
					fetch(false);
				});
			});
		}
		
		function getPresets() {
			$.ajax({
                url: 'getFilters',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
						initPresets(data['presets']);
					}
				}
			});
		}

        function initContent(data) {
            itemsDS = [];
            $('#dataHolder').html('');
            all = data['activities'];
            if (all.length == 0) {
				flt = data['filter'].replace('Activities', 'Looking for activities ');
                $('#ht').html('No activities found<p>' + flt);
                $('#runs tbody').html('');
                $('#runs').trigger('update');
                $('#runs').tablesorter();
                $('#runs').hide();
                $('#overall').hide();
				$('#overallLoader').html('');
                return false;
            }
            $('#overall').show();
			$('#overallLoader').html('');
            $('#runs').show();
			$('#pagerMenu').show();
			if ("Activities" !== data['filter']) {
				$('#ht').html(data['filter'] + '<p>');
			} else {
				$('#ht').html('');
			}
			averageData = '';
			if (data['avgDaily'] != '') {
				averageData = '<tr><td>Average daily</td><td>' + data['avgDaily'] + ' km</td></tr>';
			}
			if (data['avgWeekly'] != '') {
				averageData += '<tr><td>Average weekly</td><td>' + data['avgWeekly'] + ' km</td></tr>';
			}
			if (data['avgMonthly'] != '') {
				averageData += '<tr><td>Average monthly</td><td>' + data['avgMonthly'] + ' km</td></tr>';
			}
            $('#overall tbody').html('<tr><td>Distance</td><td>' + data['totalDistance'] + " km</td><tr><td>Time</td><td>" + data['totalTime'] + '</td><tr><td>Average speed</td><td>' + data['avgSpeed'] + ' km/h</td></tr>' +
                '<tr><td>Average distance</td><td>' + data['avgDist'] + ' km</td></tr>' + averageData +
				'<tr><td>Elevation gain</td><td>' + data['elePos'] + ' m</td></tr><tr><td>Elevation loss</td><td>' + data['eleNeg'] + ' m</td></tr><tr><td>Running distance(>9km/h)</td><td>' + data['totalRunDist'] + ' km</td></tr>');
			if (data['WMT'] != 'none') {
				initMonthlyTotals(data['mtotals']);
				initWeeklyTotals(data['wtotals']);
			}
            runsHtml = '';
            optsAll = '';
            var dialog = {
                autoOpen: false,
                modal: false,
                show: "blind",
                hide: "blind",
                buttons: {
                    "Close": function() {
                        $(this).dialog("close");
                    }
                },
                width: Math.min($(window).width() * 0.7, 600),
                height: Math.min($(window).height() * 0.85, 800),
                create: function(event) {
                    $(event.target).parent().css({
                        'position': 'fixed',
                        "left": 50,
                        "top": 150
                    });
                }
            };
            var crun = 0;
            var ctrail = 0;
            var cup = 0;
            var chike = 0;
            var cwalk = 0;
            var coth = 0;
            $.each(all, function(i, item) {
                var isMod = item['isModified'] == 'y';
				dateStr = item['date'];
				if (compactDate) {
					dateStr = item['day'] + '.' + (item['month'] + 1) + '.' + (item['year'] - 2000);
				}
                runsHtml += '<tr><td>' + (i + 1) + '</td><td><div id="date' + i + '">' + dateStr + '</div></td><td><div class="runitem" id="item' + i + '">' + (isMod ? '<i>' : '') + decodeURIComponent(item['name']) + (isMod ? '</i>' : '') +
                    '</div></td><td><div id="type' + i + '">' + item['type'] + '</div></td><td>' +
                    item['dist'] + '</td><td>' + item['timeTotal'] + '</td><td>' + item['avgPace'] + '</td><td>' + item['avgSpeed'] + '</td>' +
                    '<td>' + formatEle(item['eleTotalPos'], item['eleTotalNeg']) + '</td>' +
                    '<td><div id="edit' + i + '" class="ui-icon ui-icon-pencil ui-state-hover runitem"></div>' +
					'<div id="feat' + i + '" class="ui-icon ui-icon-note ui-state-hover runitem"></div>' +
                    '<div id="compare' + i + '" class="ui-icon ui-icon-arrowthick-2-e-w ui-state-hover runitem"></div>' +
                    '<div id="trash' + i + '" class="ui-icon ui-icon-trash ui-state-hover runitem"></div></td></tr>';
                $('#dataHolder').append('<div style="display: none;" id="data' + i + '"></div>');
                $('#dataHolder').append('<div style="display: none;" id="ui' + i + '"></div>');
                distr = item['speedDist'];
                tableHtml = '<span class="highlight"><table><thead><th>Range</th><th>Time</th><th>Distance</th><th>Gain</th><th>Loss</th></thead><tbody>';
                $.each(distr, function(i, diap) {
                    tableHtml += '<tr><td><strong>' + diap['range'] + ' km/h</strong></td><td>' + diap['time'] + '</td><td>' + diap['dist'] + '</td><td><span class="green">' + diap['elePos'] + '</span></td><td><span class="red">' + diap['eleNeg'] + '</span></td></tr>';
                });
                tableHtml += '</tbody></table></span>';
                splits = item['splits'];
                splitHtml = '<span class="highlight"><table><thead><th>Point(km)</th><th>Pace</th><th>Avg speed</th><th>Diff</th><th>Total time</th><th>Acc speed</th></thead><tbody>';
                $.each(splits, function(i, sp) {
                    splitHtml += '<tr><td><strong>' + round(sp['total']) + '</strong></td><td>' + sp['pace'] + '</td><td>' + sp['speed'] + '</td><td>' + formatEleDiff(sp['ele']) + '</td><td>' + sp['timeTotal'] +
                        '</td><td>' + sp['accumSpeed'] + '</td></tr>';
                });
                splitHtml += '</tbody></table></span>';
                filename = item['genby'].endsWith('.gpx') ? item['genby'].substring(0, item['genby'].length - 4) : item['genby'];
                itemsDS.push(function() {
                    $('#ui' + i).dialog(dialog);
                    $('#ui' + i).html($('#data' + i).html());
                    $('#ui' + i).dialog('option', 'title', 'Details ' + $('#item' + i).text());
                    $('#ui' + i).dialog('open');
                });
                var origData = item['origData'];
                var extLinks = '<a href="' + filename + '" target="_blank"><input class="hovs" type="image" src="extview-icon.png" width="60" height="60" /></a>';
                if (item['garminLink'] != 'none') {
                    extLinks += '<a href="' + item['garminLink'] + '" target="_blank"><input class="hovs" type="image" src="garmin-icon.png" width="60" height="60" /></a>';
                }
                if (item['ccLink'] != 'none') {
                    extLinks += '<a href="' + decodeURIComponent(item['ccLink']) + '" target="_blank"><input class="hovs" type="image" src="relivecc-icon.png" width="60" height="60" /></a>';
                }
                if (item['photosLink'] != 'none') {
                    extLinks += '<a href="' + decodeURIComponent(item['photosLink']) + '" target="_blank"><input class="hovs" type="image" src="photos-icon.png" width="60" height="60" /></a>';
                }
				tags = $.parseJSON(item['dashboards']);
				dashboardTags = '<span class="dashboardList">';
				$.each(tags, function(d, itemd) {
					if (d > 0) {
						dashboardTags += ',&nbsp;';
					}
					dashboardTags += decodeURIComponent(itemd);
				});
				dashboardTags += '</span><hr>';
                $('#data' + i).append(extLinks + '<hr>' + dashboardTags + '<ul><li></li>' + '<table><tbody><tr><td>Date</td><td>' + item['startAt'] + '</td></tr><tr><td>Distance</td><td>' +
                    item['dist'] + (isMod ? '<em> / ' + origData['dist'] + '*</em>' : '') + '</td></tr><tr><td>Total time</td><td>' + item['timeTotal'] + (isMod ? '<em> / ' + origData['timeTotal'] + '*</em>' : '') +
                    '</td></tr><tr><td>Elevation gain</td><td>' +
                    '<span class="green">' + item['eleTotalPos'] + (isMod ? '<em> / ' + origData['eleTotalPos'] + '*</em>' : '') + '</span></td></tr><tr><td>Elevation loss</td><td>' + '<span class="red">' +
                    item['eleTotalNeg'] + (isMod ? '<em> / ' + origData['eleTotalNeg'] + '*</em>' : '') + '</span></td></tr><tr><td>' +
                    'Running|>9km/h| time</td><td>' + (isMod ? '<em>' : '') + item['timeRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running|>9km/h| distance</td><td>' + (isMod ? '<em>' : '') +
                    item['distRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running|>9km/h| elevation gain</td><td>' +
                    '<span class="green">' + (isMod ? '<em>' : '') + item['eleRunningPos'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Running|>9km/h| elevation loss</td><td>' +
                    '<span class="red">' + (isMod ? '<em>' : '') + item['eleRunningNeg'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Rest time</td><td>' + (isMod ? '<em>' : '') + item['timeRest'] + (isMod ? '*</em>' : '') +
                    '</td></tr><tr><td>Average speed</td><td>' + item['avgSpeed'] + (isMod ? '<em> / ' + origData['avgSpeed'] + '*</em>' : '') +
                    '</td></tr><tr><td>Average pace</td><td>' + item['avgPace'] + (isMod ? '<em> / ' + origData['avgPace'] + '*</em>' : '') + '</td></tr></tbody></table><hr><li><h3>Speed distribution</h3>' +
                    '</li>' + tableHtml + '</li><hr><li><h3>Splits</h3></li>' + splitHtml + '</ul>');
            });
			var happc = '<div id="typesDistr">' + all.length + (all.length != 1 ? ' results' : ' result') + '</div>';
			$('#ht').append(happc);
			charts = data['charts'];
            $('#typesDistr').click(function() {
					$('#typesDialog').html('<strong>Count by</strong><p><fieldset><input type="radio" name="selectChart" value="byType" checked="">Type' +
						'<input type="radio" name="selectChart" value="byDist">Distance' +
						'<input type="radio" name="selectChart" value="bySpeed">Speed' +
						'<input type="radio" name="selectChart" value="byEle">Denivelation+' +
						'<input type="radio" name="selectChart" value="byRun">Running distance' +
						'<input type="radio" name="selectChart" value="byDuration">Duration' +
						'<input type="radio" name="selectChart" value="byMonth">Month' +
						'<input type="radio" name="selectChart" value="byYear">Year' +
						'<input type="radio" name="selectChart" value="byDay">Day' +
						'<input type="radio" name="selectChart" value="byHour">Hour</fieldset><hr>' +
						'<div id="byType"></div><div id="byDist"></div><div id="bySpeed"></div><div id="byEle"></div><div id="byRun"></div>' +
						'<div id="byDuration"></div><div id="byMonth"></div><div id="byYear"></div><div id="byDay"></div><div id="byHour"></div>');
					$('#byType').insertFusionCharts(getChart("Distribution", "By type", "Type", "Count", "", getChartData(charts['byType'])));
					$('#byDist').insertFusionCharts(getChart("Distribution", "By distance", "KM", "Count", "", getChartData(charts['byDist'])));
					$('#bySpeed').insertFusionCharts(getChart("Distribution", "By speed", "KM/H", "Count", "", getChartData(charts['bySpeed'])));
					$('#byEle').insertFusionCharts(getChart("Distribution", "By positive denivelation", "Meters gained", "Count", "", getChartData(charts['byEle'])));
					$('#byRun').insertFusionCharts(getChart("Distribution", "By running distance", "KM", "Count", "", getChartData(charts['byRun'])));
					$('#byDuration').insertFusionCharts(getChart("Distribution", "By duration", "Time", "Count", "", getChartData(charts['byDuration'])));
					$('#byMonth').insertFusionCharts(getChart("Distribution", "By month", "Month", "Count", "", getChartData(charts['byMonth'])));
					$('#byYear').insertFusionCharts(getChart("Distribution", "By year", "Year", "Count", "", getChartData(charts['byYear'])));
					$('#byDay').insertFusionCharts(getChart("Distribution", "By day of week", "Day of week", "Count", "", getChartData(charts['byDay'])));
					$('#byHour').insertFusionCharts(getChart("Distribution", "By starting hour", "Period of day", "Count", "", getChartData(charts['byHour'])));
					$('input[name=selectChart]').change(function () {
						chid = $('input[name=selectChart]:checked').val();
						$("div[id^=by]").hide();
						$('#' + chid).show();
					});
					$("div[id^=by]").hide();
					$('#byType').show();
					$('#typesDialog').dialog('option', 'title', 'Results');
					$('#typesDialog').dialog('open');
			});
            $('#runs tbody').html(runsHtml);
            $('#runs').trigger('update');
			$('#runs').trigger('pageSize', 20);
            $('#runs').trigger("sorton", [
                [
                    [1, 'dates']
                ]
            ]);
            var table = document.getElementById('runs');
            var rowLength = table.rows.length;
            for (var i = 1; i < rowLength; i++) {
                table.rows[i].cells[0].innerHTML = (i).toString();
            }
            $.each(all, function(i, item) {
                optsAll += '<option genby="' + item['genby'] + '" value="#' + (i + 1) + ' ' + $('#item' + i).text() + '">' + $('#item' + i).text() + ' ' + $('#date' + i).text() + '</option>';
            });
            $.each(all, function(i, item) {
                $('#compare' + i).click(function() {
                    $('#comparable').html('Compare with <select id="selectComp">' + optsAll + '</select><div id="compareResults" />');
                    $('#comparable').dialog('option', 'title', 'Compare ' + $('#item' + i).text() + ' ' + $('#date' + i).text());
                    $('#comparable').attr('file1', item['genby']);
                    $('#comparable').dialog('open');
                });
                $('#edit' + i).click(function() {
                    type = $('#type' + i).text();
					optsAdd = '<option value="">---Keep---</option>';
					optsRem = '<option value="">---Keep---</option>';
					dashboards = item['dashboards'];
					for (q = 0; q < dashCount; ++q) {
						name = $('#dashboard' + q).attr('name');
						if (dashboards.indexOf(name) == -1) {
							optsAdd += '<option value="' + name + '">' + name + '</option>';
						} else {
							optsRem += '<option value="' + name + '">' + name + '</option>';
						}
					}
                    $('#editable').html('<table><tbody><tr><td>Name </td><td><input type="text" id="chooseName" value="' + $('#item' + i).text() + '"/></td></tr><tr><td>Type </td><td><select id="chooseType">' + getOption("Running", type) +
                        getOption("Trail", type) + getOption("Uphill", type) + getOption('Hiking', type) + getOption('Walking', type) + getOption('Other', type) + '</select></td>' +
                        '<tr><td>Garmin </td><td><input size="50" type="text" id="chooseGarmin" value="' + (item['garminLink'] != 'none' ? item['garminLink'] : "") + '"/></td></tr>' +
                        '<tr><td>Relive CC </td><td><input size="50" type="text" id="chooseCC" value="' + (item['ccLink'] != 'none' ? decodeURIComponent(item['ccLink']) : "") + '"/></td></tr>' +
                        '<tr><td>Photos </td><td><input size="50" type="text" id="choosePhotos" value="' + (item['photosLink'] != 'none' ? decodeURIComponent(item['photosLink']) : "") + '"/></td></tr>' +
                        '<tr><td>Add to dashboard</td><td><select id="addToDash">' + optsAdd + '</select></td></tr>' + 
						'<tr><td>Remove from dashboard</td><td><select id="remFromDash">' + optsRem + '</select></td></tr></tbody></table>' +
						'<u><h2>Modifications</h2></u><p><h4>Optional. Leave empty to keep old data.</h4>' +
                        '<table><tbody><tr><td>Actual distance</td><td><input type="text" id="actDist" /></td></tr>' +
                        '<tr><td>Actual time(hh:mm:ss)</td><td><input type="text" id="actTime" /></td></tr>' +
                        '<tr><td>Actual elevation gain</td><td><input type="text" id="actGain" /></td></tr>' +
                        '<tr><td>Actual elevation loss</td><td><input type="text" id="actLoss" /></td></tr>' + '</tbody></table>');
                    $('#editable').dialog('option', 'title', 'Edit ' + $('#item' + i).text() + ' ' + $('#date' + i).text());
                    $('#editable').attr('genby', item['genby']);
                    $('#editable').attr('refname', 'item' + i);
                    $('#editable').attr('reftype', 'type' + i);
                    $('#editable').dialog('open');
                });
                $('#trash' + i).click(function() {
                    $('#removable').html('Remove this activity?');
                    $('#removable').dialog('option', 'title', 'Remove ' + $('#item' + i).text() + ' ' + $('#date' + i).text());
                    $('#removable').attr('genby', item['genby']);
                    $('#removable').dialog('open');
                });
            });
            for (i = 0; i < itemsDS.length; ++i) {
                $('#runs tr:eq(' + (i + 1) + ') td:not(:last-child)').click(itemsDS[i]);
            }
            $('#rescanButton').click(function() {
                $('#rescanDialog').html('Really rescan remote folder for activities?');
                $('#rescanDialog').dialog('option', 'title', 'Potentially unsafe operation');
                $('#rescanDialog').dialog('open');
            });
        }

        function fetch(getWMTotals) {
            var period = $('input[name=selectPeriod]:checked').attr('id');
            var ds = $('#dtStart').datepicker('getDate');
            var de = $('#dtEnd').datepicker('getDate');
            var nf = encodeURIComponent($('#searchName').val());
            $('#search').button("option", "disabled", true);
			$('#overall').hide();
			if ($('#overallBtn').length == 0) {
				$('#overallLoader').html('<div class="loader"></div>');
			}
			$('#runs').hide();
			$('#ht').html('<div class="loader"></div>');
			$('#pagerMenu').hide();
			dashQ = $('.selectedDash').length == 0 ? 'Main' : encodeURIComponent($('.selectedDash').attr('name'));
            $.ajax({
                url: 'fetch',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json',
                    'run': $('#checkbox-1').prop('checked'),
                    'trail': $('#checkbox-2').prop('checked'),
                    'uphill': $('#checkbox-3').prop('checked'),
                    'hike': $('#checkbox-4').prop('checked'),
                    'walk': $('#checkbox-5').prop('checked'),
                    'other': $('#checkbox-6').prop('checked'),
                    'dateOpt': parseInt(period[period.length - 1]) - 1,
                    'dtStart': ds ? (ds.getMonth() + 1) + '/' + ds.getDate() + '/' + ds.getFullYear() : '',
                    'dtEnd': de ? (de.getMonth() + 1) + '/' + de.getDate() + '/' + de.getFullYear() : '',
                    'nameFilter': nf,
                    'dmin': $('#spinnerMin').val(),
                    'dmax': $('#spinnerMax').val(),
					'dashboard': dashQ,
					'getWMTotals': getWMTotals
                },
                statusCode: {
                    200: function(data) {
						$(".presetButton").removeClass('selectedDash');
                        initContent(data);
                        $('#search').button("option", "disabled", false);
						for (i = 0; i < dashCount; ++i) {
							$('#dashboard' + i).prop("disabled", false);
						}
                    },
                    400: function(data) {
						$(".presetButton").removeClass('selectedDash');
                        $('#infoDialog').html('Invalid distance arguments!');
                        $('#infoDialog').dialog('option', 'title', 'Bad data');
                        $('#infoDialog').dialog('open');
                        $('#search').button("option", "disabled", false);
						for (i = 0; i < dashCount; ++i) {
							$('#dashboard' + i).prop("disabled", false);
						}
                    }
                }
            });
        }

        function disableDates() {
            $('#dtStart').datepicker('disable');
            $('#dtEnd').datepicker('disable');
        }

        function getStat(data, opt) {
            if (data[opt]) {
                return data[opt];
            }
            return opt == 'ach' ? 'Locked' : '---';
        }
		
		function linkAchToActivity(ind, data, opt) {
			if (data[opt]) {
				$('#bestOf tr:eq(' + ind + ')').click(function() {
					window.open(data['genby'], '_blank');
				});
			} else {
				$('#bestOf tr:eq(' + ind + ')').click(function() {
					$('#infoDialog').html('Achievement not unlocked!');
					$('#infoDialog').dialog('option', 'title', 'No data');
					$('#infoDialog').dialog('open');
				});
			}
		}

        function getBest() {
            initSplitsBest();
			$('#bestOf').hide();
			if ($('#bestOfBtn').length == 0) {
				$('#bestOfLoader').html('<div class="loader"></div>');
			}
            $.ajax({
                url: 'best',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
                        var farthest = data['longest'];
                        var fastest = data['fastest'];
                        var maxAsc = data['maxAsc'];
                        var maxRun = data['maxRun'];
                        var k1 = data['1K'];
                        var k25 = data['2K5'];
                        var k5 = data['5K'];
                        var k10 = data['10K'];
                        var semi = data['21K'];
                        var k30 = data['30K'];
                        var marathon = data['42K'];
                        $('#bestOf tbody').html('<tr><td>Farthest</td><td>' + getStat(farthest, 'ach') + '</td><td>' + getStat(farthest, 'when') + '</td></tr>' +
                            '<tr><td>Fastest</td><td>' + getStat(fastest, 'ach') + '</td><td>' + getStat(fastest, 'when') + '</td></tr>' +
                            '<tr><td>Max ascent</td><td>' + getStat(maxAsc, 'ach') + '</td><td>' + getStat(maxAsc, 'when') + '</td></tr>' +
							'<tr><td>Max running distance</td><td>' + getStat(maxRun, 'ach') + '</td><td>' + getStat(maxRun, 'when') + '</td></tr>' +
                            '<tr><td>1K</td><td>' + getStat(k1, 'ach') + '</td><td>' + getStat(k1, 'when') + '</td></tr>' +
                            '<tr><td>2.5K</td><td>' + getStat(k25, 'ach') + '</td><td>' + getStat(k25, 'when') + '</td></tr>' +
                            '<tr><td>5K</td><td>' + getStat(k5, 'ach') + '</td><td>' + getStat(k5, 'when') + '</td></tr>' +
                            '<tr><td>10K</td><td>' + getStat(k10, 'ach') + '</td><td>' + getStat(k10, 'when') + '</td></tr>' +
                            '<tr><td>Half-marathon</td><td>' + getStat(semi, 'ach') + '</td><td>' + getStat(semi, 'when') + '</td></tr>' +
                            '<tr><td>30K</td><td>' + getStat(k30, 'ach') + '</td><td>' + getStat(k30, 'when') + '</td></tr>' +
                            '<tr><td>Marathon</td><td>' + getStat(marathon, 'ach') + '</td><td>' + getStat(marathon, 'when') + '</td></tr>');
						$('#bestOf').show();
						$('#bestOfLoader').html('');
						linkAchToActivity(0, farthest, 'ach');
						linkAchToActivity(1, fastest, 'ach');
						linkAchToActivity(2, maxAsc, 'ach');
						linkAchToActivity(3, maxRun, 'ach');
						linkAchToActivity(4, k1, 'ach');
						linkAchToActivity(5, k25, 'ach');
						linkAchToActivity(6, k5, 'ach');
						linkAchToActivity(7, k10, 'ach');
						linkAchToActivity(8, semi, 'ach');
						linkAchToActivity(9, k30, 'ach');
						linkAchToActivity(10, marathon, 'ach');
                    }
                }
            });
        }

        function initSplitsBest() {
            $.ajax({
                url: 'bestSplits',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
                        $('#bestSplits').dialog('option', 'title', 'Best split times dy distance');
                        totals = data['totals'];
                        splits = '';
                        $.each(totals, function(i, item) {
                            splits += '<tr><td><strong>' + item['point'] + '</strong></td><td>' + item['ach'] + '</td><td class="runitem">' + decodeURIComponent(item['name']) + '</td><td>' + item['date'] + '</td>' +
                                '<td>' + item['pace'] + '</td><td>' + item['speed'] + '</td></tr>';
                        });
                        $('#bestSplits').html('<span class="highlight"><table id="bestSplitsTable"><thead><tr><th>Distance</th><th>Best time</th><th>Name</th><th>Date</th>' +
                            '<th>Pace</th><th>Speed</th></tr></thead><tbody>' + splits + '</tbody></table></span>');
						$.each(totals, function(i, item) {
							$('#bestSplitsTable tr:eq(' + (i + 1) + ')').click(function() {
								window.open(item['genby'], '_blank');
							});
						});
                    }
                }
            });
        }
		
		function getChart(caption, subcap, xname, yname, suff, data, id) {
			return {
					type: "column2d",
					width: "700",
					height: "300",
					dataFormat: "json",
					id: id,
					dataSource: {
						"chart": {
							"caption": caption,
							"subCaption": subcap,
							"xAxisName": xname,
							"yAxisName": yname,
							"exportEnabled" : "1",
							"numberSuffix": suff,
							"theme": "fint"
						},
						data: data
					}
				}
		}
		
		function getChartData(chart) {
			result = [];
			$.each(chart, function(i, item) {
				result.push({
					"label": item['info'].toString(),
					"value": item['data']
				});
			});
			return result;
		}
		
		function getYearData(data, type) {
			result = [];
			$.each(data, function(i, item) {
				mdata = item['data'];
				ckey = 'count' + type;
				cval = mdata.hasOwnProperty(ckey) ? '(' + mdata[ckey] + ')' : '';
				result.push({
					"label": item['month'] + cval,
					"value": parseFloat(mdata[type]).toFixed(1)
				});
			});
			return result;
		}
		
		function genContainerHTML(year) {
			return '<div id="mtContainerRT' + year + '"></div>' + '<div id="mtContainerR' + year + '"></div>' + '<div id="mtContainerT' + year + '"></div>' +
				'<div id="mtContainerU' + year + '"></div>' + '<div id="mtContainerH' + year + '"></div>' + '<div id="mtContainerD' + year + '"></div>' +
				'<div id="mtContainerA' + year + '"></div>';
		}
		
		function gcn(type, weekInd) {
			return 'wContainer' + weekInd + type;
		}
		
		function gcnDiv(type, weekInd) {
			return '<div id="' + gcn(type, weekInd) + '"></div>';
		}
		
		function genContainerHTML2(weekInd) {
			return gcnDiv('rt', weekInd) + gcnDiv('r', weekInd) + gcnDiv('t', weekInd) + gcnDiv('u', weekInd) + gcnDiv('h', weekInd) + gcnDiv('d', weekInd) + gcnDiv('a', weekInd);
		}
		
		function showContainer(type) {
			$("div[id^=mtContainer]").hide();
			$("div[id^=mtContainer" + type + "2]").show();
		}
		
		function genRadioM(type, name, checked) {
			ch = (checked ? ' checked' : '');
			return '<input type="radio" name="selectTypeM" value="' + type + '" ' + ch + '>' + name + '</input>';
		}

        function initMonthlyTotals(data) {
            $('#mTotals').dialog('option', 'title', 'Total distance by month');
			radioHtml = '<strong>Choose type</strong><p><fieldset>' + genRadioM('RT', 'Run&Trail', true) + genRadioM('R', 'Run') + genRadioM('T', 'Trail') + genRadioM('U', 'Uphill')
				+ genRadioM('H', 'Hike') + genRadioM('D', 'Denivelation+') + genRadioM('A', 'All') + '</fieldset>';
			containerHtml = '';
            $.each(data, function(i, item) {
				containerHtml += genContainerHTML(item['year']);
            });
            $('#mTotals').html(radioHtml + '<hr/>' + containerHtml);
			$("div[id^=mtContainer]").hide();
			$.each(data, function(i, item) {
				ydata = item['data'];
				year = item['year'];
				$("#mtContainerRT" + year).insertFusionCharts(getChart("Running&Trail " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 'rt')));
				$("#mtContainerR" + year).insertFusionCharts(getChart("Running " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 'r')));
				$("#mtContainerT" + year).insertFusionCharts(getChart("Trail running " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 't')));
				$("#mtContainerU" + year).insertFusionCharts(getChart("Uphill climbing " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 'u')));
				$("#mtContainerH" + year).insertFusionCharts(getChart("Hiking " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 'h')));
				$("#mtContainerD" + year).insertFusionCharts(getChart("Positive denivelation " + item['year'], "Year monthly report", "Month", "Denivelation", "m", getYearData(ydata, 'totalPositiveEl')));
				$("#mtContainerA" + year).insertFusionCharts(getChart("All activities " + item['year'], "Year monthly report", "Month", "Distance", "km", getYearData(ydata, 'a')));
				$('input[name=selectTypeM]').change(function () {
					showContainer($('input[name=selectTypeM]:checked').val());
				});
				if (i == 0) {
					showContainer("RT");
				}
			});
        }
		
		function genRadioT(type, name, checked) {
			ch = (checked ? ' checked' : '');
			return '<input type="radio" name="selectTypeW" value="' + type + '"' + ch + ' hrn="' + name + '">' + name + '</input>';
		}
		
		function genRadioYear(year, ind, checked) {
			ch = (checked ? ' checked' : '');
			return '<input type="radio" name="selectYearW" value="' + year + '" ind="' + ind + '" ' + ch + '>' + year + '</input>';
		}
		
		function getWeekData(data, type, fr, to) {
			result = [];
			$.each(data, function(i, item) {
				if (i >= fr && i < to) {
					ckey = 'count' + type;
					cval = item.hasOwnProperty(ckey) ? '(' + item[ckey] + ')' : '';
					info = item['info'];
					if (item.hasOwnProperty(ckey) && item[ckey] == 0) {
						cval = '';
						info = 'Empty Week';
					}
					result.push({
						"label": info + cval,
						"value": parseFloat(item[type]).toFixed(1)
					});
				}
			});
			return result;
		}
		
		var wtotals = [];
		var currentYearInd = 0;
		
		function initWeeklyTotals(data) {
			$('#wTotals').dialog('option', 'title', 'Total distance by week');
			radioHtml = '<strong>Choose type</strong><p><fieldset>' + genRadioT('rt', 'Run&Trail', true) + genRadioT('r', 'Run') + genRadioT('t', 'Trail') + genRadioT('u', 'Uphill')
				+ genRadioT('h', 'Hike') + genRadioT('d', 'Denivelation+') + genRadioT('a', 'All') + '</fieldset>';
			menuHtml = '<strong>Choose year</strong>';
			yearSelectHtml = '<fieldset>';
            containerHtml = '';
			$.each(data, function(i, item) {
				yearSelectHtml += genRadioYear(item['year'], i, i == 0);
            });
			yearSelectHtml += '</fieldset>';
			for (j = 1; j <= 4; ++j) {
				containerHtml += genContainerHTML2(j);
			}
            $('#wTotals').html(radioHtml + '<p>' + menuHtml + '<p>' + yearSelectHtml + '<hr>' + containerHtml);
			wtotals = data;
			$.each(wtotals, function(i, item) {
				ydata = item['data'];
				year = item['year'];
				f = function () {
					currentYearInd = parseInt($('input[name=selectYearW]:checked').attr('ind'));
					for (j = 1; j <= 4; ++j) {
						fr = 13 * (j - 1);
						to = (j < 4 ? 13 * j : 100);
						optType = $('input[name=selectTypeW]:checked').val();
						optText = $('input[name=selectTypeW]:checked').attr('hrn') + ' ' + wtotals[currentYearInd]['year'];
						chart = getChartFromId('wid' + j);
						if (chart !== undefined) {
							chart.dispose();
						}
						ftype = optType !== 'd' ? optType : 'totalPositiveEl';
						wd = getWeekData(wtotals[currentYearInd]['data'], ftype, fr, to);
						meas = optType !== 'd' ? 'km' : 'm';
						yax = optType !== 'd' ? 'Distance' : 'Denivelation';
						if (wd.length > 0) {
							$('#' + gcn(optType, j)).insertFusionCharts(getChart(optText, "Year weekly report", "Week", yax, meas, wd, 'wid' + j));
						}
					}
				};
				$('input[name=selectTypeW],[name=selectYearW]').change(f);
				if (i == 0) {
				  f.call();
				}
			});
		}

        function checkCookieVal(cookieVal) {
            $.ajax({
                url: 'checkCookie',
                method: 'POST',
                dataType: 'json',
                statusCode: {
                    200: function(xhr) {
                        $('#loginButton').prop("disabled",true);
                        $('#loginButton').text('Authorized');
						$('#loginButton').css({'cursor': 'default'});
                    },
                    401: function(xhr) {
                        $('#loginButton').prop("disabled",false);
                    }
                }
            });
        }
		
		var dashCount = 0;
		var fetchAfterDashClick = true;

        function initDashboards(fetchAfterInit) {
            $.ajax({
                url: 'getDash',
                method: 'POST',
                dataType: 'json',
                statusCode: {
                    200: function(data) {
                        arr = data['dashboards'];
                        dashHtml = '<ul id="dashSort">';
						dashCount = arr.length;
                        $.each(arr, function(i, item) {
                            dashHtml += '<li class="dashButton" id="dashboard' + i + '">' + decodeURIComponent(item) + '</li>';
                        });
                        $('#allDash').html(dashHtml + '</ul>');
						$.each(arr, function(i, item) {
							if (item == 'Main') {
								$('#dashboard' + i).addClass('selectedDash');
							} else {
								$('#dashboard' + i).addClass('notSelectedDash');
							}
							$('#dashboard' + i).attr('name', decodeURIComponent(item));
							$('#dashboard' + i).click(function() {
								if ($('#dashboard' + i).hasClass('selectedDash')) {
									return;
								}
								if ($('#search').button("option", "disabled")) {
									return;
								}
								$('#dashboard' + i).addClass('selectedDash');
								$('#dashboard' + i).removeClass('notSelectedDash');
								for (j = 0; j < dashCount; ++j) {
									if (j != i) {
										$('#dashboard' + j).prop("disabled",true);
										$('#dashboard' + j).addClass('notSelectedDash');
										$('#dashboard' + j).removeClass('selectedDash');
									}
								}
								$('#runs').hide();
								$('#ht').html('<div class="loader"></div>');
								$('#pagerMenu').hide();
								$('#runs').trigger('pagerUpdate', 1);
								$('#runs').trigger('pageSize', 20);
								$('a').removeClass('current');
								$('#defPage').addClass('current');
								if (fetchAfterDashClick) {
									$('#checkbox-1').prop('checked', true).change();
									$('#checkbox-2').prop('checked', true).change();
									$('#checkbox-3').prop('checked', true).change();
									$('#checkbox-4').prop('checked', true).change();
									$('#checkbox-5').prop('checked', false).change();
									$('#checkbox-6').prop('checked', false).change();
									$('#radio-6').prop('checked', true).change();
									$('#spinnerMin').val('');
									$('#spinnerMax').val('');
									$('#searchName').val('');
									fetch(false);
								}
							});
                        });
						if (fetchAfterInit) {
							fetch(false);
						}
                    }
                }
            });
        }

        function checkWidth() {
			wid = $(window).width();
            if (wid < 1200) {
                initSecondaryDialogs();
                $('#bestOfWrap').append('<button id="bestOfBtn">Best achievements</button>');
                $('#bestOfBtn').button();
                $('#overallWrap').append('<button id="overallBtn">Selection totals</button>');
                $('#overallBtn').button();
                $('#bestOf').dialog('option', 'title', 'Best achievements');
                $('#overall').dialog('option', 'title', 'Selection totals');
                $('#bestOfBtn').click(function() {
                    $('#bestOf').dialog('open');
                });
                $('#overallBtn').click(function() {
                    $('#overall').dialog('open');
                });
                $('#titleTotals').remove();
                $('#titleBest').remove();
            }
			if (wid < 1800) {
				compactDate = true;
				if (wid >= 1600) {
					$('#runs').css({'width': '85%'});
				}
			}
			if (wid >= 1400 && wid < 1600) {
				$('#runs').css({'width': '90%'});
			}
			if (wid < 1400) {
				$('#runs').css({'width': '95%'});
			}
        }

        $(document).ready(function() {
            checkWidth();
            var ind = document.cookie.indexOf("xruncalc=");
            var cookieVal = '';
            if (ind != -1) {
                cookieVal = document.cookie.substring(ind + 9);
            }
            checkCookieVal();
            $('#selectAll').button();
            $('#search').button();
            $('#search').click(function() {
                fetch(false);
            });
			$('#savePresets').button();
			$('#savePresets').click(function() {
                $('#presetsDlg').html('Preset name&nbsp;<input type="text" id="newPresetName" />');
				$('#presetsDlg').dialog('option', 'title', 'Save filter preset');
				$('#presetsDlg').dialog('open');
            });
			$('#renamePreset').click(function() {
				renameOps = '<select id="selectPreset">';
				$('.presetButton').each(function() {
					pname = $(this).text();
					renameOps += '<option value="' + pname + '">' + pname + '</option>';
				});
				renameOps += '</select>';
				$('#renamePresetDlg').html('<table><tbody><tr><td>Choose preset</td><td>' + renameOps + '</td></tr><tr><td>New name</td><td><input type="text" id="setPresetName" /></td></tr></tbody></table>');
				$('#renamePresetDlg').dialog('option', 'title', 'Rename filter preset');
				$('#renamePresetDlg').dialog('open');
			});
			$('#saveOrder').click(function() {
				$('#confirmDialogPresets').html('Save the presets in this order?');
				$('#confirmDialogPresets').dialog('option', 'title', 'Save preset order');
				$('#confirmDialogPresets').dialog('open');
			});
			$('#reorderDash').click(function() {
				$('#confirmDialogDash').html('Save the dashboard in this order?');
				$('#confirmDialogDash').dialog('option', 'title', 'Save dashboard order');
				$('#confirmDialogDash').dialog('open');
			});
			$('#removePreset').click(function() {
				removeOps = '<select id="selectPresetRem">';
				$('.presetButton').each(function() {
					pname = $(this).text();
					removeOps += '<option value="' + pname + '">' + pname + '</option>';
				});
				removeOps += '</select>';
				$('#removePresetDlg').html('Choose preset ' + removeOps);
				$('#removePresetDlg').dialog('option', 'title', 'Remove filter preset');
				$('#removePresetDlg').dialog('open');
			});
            $('#bestTotalsBtn').button();
            $('#mTotalsBtn').button();
			$('#wTotalsBtn').button();
            $('input[name=selectPeriod]').checkboxradio();
            $('#checkbox-1').checkboxradio();
            $('#checkbox-2').checkboxradio();
            $('#checkbox-3').checkboxradio();
            $('#checkbox-4').checkboxradio();
            $('#checkbox-5').checkboxradio();
            $('#checkbox-6').checkboxradio();
            $('#selectAll').click(function() {
                $("#checkbox-1").prop('checked', true).change();
                $("#checkbox-2").prop('checked', true).change();
                $("#checkbox-3").prop('checked', true).change();
                $("#checkbox-4").prop('checked', true).change();
                $("#checkbox-5").prop('checked', true).change();
                $("#checkbox-6").prop('checked', true).change();
            });
            $("#bestTotalsBtn").click(function() {
                $("#bestSplits").dialog('open');
            });
            $("#mTotalsBtn").click(function() {
                $("#mTotals").dialog('open');
            });
			$("#wTotalsBtn").click(function() {
                $("#wTotals").dialog('open');
            });
            $("#radio-1").change(disableDates);
            $("#radio-2").change(disableDates);
            $("#radio-3").change(disableDates);
            $("#radio-4").change(disableDates);
            $("#radio-5").change(disableDates);
            $("#radio-6").change(disableDates);
            $("#radio-7").change(function() {
                if (this.checked) {
                    $('#dtStart').datepicker('enable');
                    $('#dtEnd').datepicker('enable');
                }
            });
            initDialogs();
            $("#loginButton").click(function() {
                $('#login').html('<table><tbody><tr><td>User </td><td><input type="text" id="loginUser" value="BatGeorgi"/></td></tr>' +
                    '<tr><td>Password </td><td><input type="password" id="loginPassword"/></td></tr></tbody></table>');
                $('#login').dialog('option', 'title', 'Login');
                $('#login').dialog('open');
            });
			$('#createDashboardButton').click(function () {
				$('#createDashboard').html('Dashboard name&nbsp;<input type="text" id="cdName" />');
				$('#createDashboard').dialog('option', 'title', 'Create new dashboard');
				$('#createDashboard').dialog('open');
			});
			$('#renameDashboardButton').click(function () {
				$('#renameDashboard').html('New name&nbsp;<input type="text" id="newDashName" />');
				$('#renameDashboard').dialog('option', 'title', 'Rename dashboard ' + $('.selectedDash').attr('name'));
				$('#renameDashboard').dialog('open');
			});
			$('#removeDashboardButton').click(function () {
				crName = $('.selectedDash').attr('name');
				$('#removeDashboard').html('Really remove dashboard ' + crName + '?');
				$('#removeDashboard').dialog('option', 'title', 'Remove dashboard ' + $('.selectedDash').attr('name'));
				$('#removeDashboard').dialog('open');
			});
            $('#dtStart').datepicker({
                yearRange: '2013:c',
                changeYear: true
            });
            $('#dtEnd').datepicker({
                yearRange: '2013:c',
                changeYear: true
            });
            $('#dtStart').datepicker('disable');
            $('#dtEnd').datepicker('disable');
            initDashboards();
			getPresets();
            fetch(true);
            
            $("#spinnerMin").spinner();
            $("#spinnerMax").spinner();
            $("#spinnerMin").spinner({
                min: 0
            });
            $("#spinnerMax").spinner({
                min: 0
            });
			$('#hideFilters').click(function() {
				if ($('#filters').css('display') == 'none') {
					$(this).text("Hide Filters");
				} else {
					$(this).text("Show Filters");
				}
				$('#filters').toggle();
			});
            getBest();
            var months = {
                'Jan': 0,
                'Feb': 1,
                'Mar': 2,
                'Apr': 3,
                'May': 4,
                'Jun': 5,
                'Jul': 6,
                'Aug': 7,
                'Sep': 8,
                'Oct': 9,
                'Nov': 10,
                'Dec': 11
            };
            $.tablesorter.addParser({
                id: 'dates',
                is: function(s) {
                    return false;
                },
                format: function(s) {
                    return parseInt(s.substring(7, 11)) * 400 + months[s.substring(3, 6)] * 32 + parseInt(s.substring(0, 2));
                },
                type: 'numeric'
            });
            $.tablesorter.addParser({
                id: 'paces',
                is: function(s) {
                    return false;
                },
                format: function(s) {
                    return parseInt(s.substring(0, s.indexOf(':'))) * 70 + parseInt(s.substring(s.indexOf(':') + 1, s.length));
                },
                type: 'numeric'
            });
            $.tablesorter.addParser({
                id: 'elevs',
                is: function(s) {
                    return false;
                },
                format: function(s) {
                    if (s.charAt(0) != '+') {
                        return 0;
                    }
                    var ind = s.indexOf('/');
                    return parseInt(ind != -1 ? s.substring(1, ind) : s.substring(1, s.length));
                },
                type: 'numeric'
            });
			var $table = $('#runs');
		    var $pager = $('.pager');

			$.tablesorter.customPagerControls({
				table          : $table,                   // point at correct table (string or jQuery object)
				pager          : $pager,                   // pager wrapper (string or jQuery object)
				pageSize       : '.left a',                // container for page sizes
				currentPage    : '.right a',               // container for page selectors
				ends           : 1,                        // number of pages to show of either end
				aroundCurrent  : 1,                        // number of pages surrounding the current page
				link           : '<a href="#">{page}</a>', // page element; use {page} to include the page number
				currentClass   : 'current',                // current page class name
				adjacentSpacer : '<span> | </span>',       // spacer for page numbers next to each other
				distanceSpacer : '<span> &#133; <span>',   // spacer for page numbers away from each other (ellipsis = &#133;)
				addKeyboard    : true,                     // use left,right,up,down,pageUp,pageDown,home, or end to change current page
				pageKeyStep    : 20                        // page step to use for pageUp and pageDown
			});

            $('#runs').tablesorter({
                headers: {
                    0: {
                        sorter: false
                    },
                    1: {
                        sorter: 'dates'
                    },
                    3: {
                        sorter: false
                    },
                    6: {
                        sorter: 'paces'
                    },
                    8: {
                        sorter: 'elevs'
                    },
                    9: {
                        sorter: false
                    }
                },
                widgets: ['numbering', 'pager']
            }).tablesorterPager({
				container: $pager,
				size: 20
			}).bind('pagerChange pagerComplete pagerInitialized pageMoved', function(e, c){
				i = 1;
				$table.find("tr:gt(0)").each(function(){
					$(this).find("td:eq(0)").text(i);
					i++;
				});
				$('#pagerOut').html('Range ' + c.startRow + ' - ' + c.endRow);
			});
			$('#runs').trigger('pagerUpdate', 1);
			$('#runs').trigger('pageSize', 20);
	}); 
    </script>
	
</head>

<body>
    <div id="heading">
        <H1><strong>Activity Tracker 3.2</strong></H1>
		<hr>
    </div>
	<div id="controls">
		<a href="upload"><input id="importButton" type="image" src="button-dark-plus-icon.png" width="40" height="40" /></a>
		<input id="rescanButton" type="image" src="button_blue_rescan.png" width="40" height="40" />
		<button id="loginButton" class="controlButton">Login</button>
		<button id="hideFilters" class="controlButton">Show Filters</button>
	</div><p><p><p><p>
	<div id="createDashboard"></div>
	<div id="renameDashboard"></div>
	<div id="removeDashboard"></div>
	<div id="userData">
	<div id="mainBar">
    <div id="filters" style="display:none">
        <fieldset>
            <legend class="legend-cap">Activity Type</legend>
            <label for="checkbox-1">Running</label>
            <input type="checkbox" name="checkbox-1" id="checkbox-1" checked/>
            <label for="checkbox-2">Trail</label>
            <input type="checkbox" name="checkbox-2" id="checkbox-2" checked/>
            <label for="checkbox-3">Uphill</label>
            <input type="checkbox" name="checkbox-3" id="checkbox-3" checked/>
            <label for="checkbox-4">Hiking</label>
            <input type="checkbox" name="checkbox-4" id="checkbox-4" checked/>
            <label for="checkbox-5">Walking</label>
            <input type="checkbox" name="checkbox-5" id="checkbox-5" />
            <label for="checkbox-6">Other</label>
            <input type="checkbox" name="checkbox-6" id="checkbox-6" />
            <button id="selectAll">Select All</button>
        </fieldset>
        <p>
            <fieldset>
                <legend class="legend-cap">Activity name</legend>
                <input type="text" name="searchName" id="searchName" />
            </fieldset>
            <p>
                <fieldset>
                    <legend class="legend-cap">Period</legend>
                    <label for="radio-1">This month</label>
                    <input type="radio" name="selectPeriod" id="radio-1">
                    <label for="radio-2">This year</label>
                    <input type="radio" name="selectPeriod" id="radio-2">
                    <label for="radio-3">Last month</label>
                    <input type="radio" name="selectPeriod" id="radio-3">
                    <label for="radio-4">Last 3 months</label>
                    <input type="radio" name="selectPeriod" id="radio-4">
                    <label for="radio-5">Last 365 days</label>
                    <input type="radio" name="selectPeriod" id="radio-5">
                    <label for="radio-6">From begining</label>
                    <input type="radio" name="selectPeriod" id="radio-6" checked>
                    <label for="radio-7">Custom</label>
                    <input type="radio" name="selectPeriod" id="radio-7">
                </fieldset>
                <p>
                    <div id="customDates">
                        <p>Start date: <input type="text" id="dtStart" />
                            <p>End date: <input type="text" id="dtEnd" />
                    </div>
                    <p>
                        <fieldset>
                            <legend class="legend-cap">Distance</legend>
                            <label for="spinnerMin">Min km</label>
                            <input id="spinnerMin" name="dmin" />
                            <label for="spinnerMax">Max km</label>
                            <input id="spinnerMax" name="dmax" />
                        </fieldset>
                        <p>
							<button id="savePresets">Save preset</button>
                            <button id="search">Search</button>
    </div>
	<div id="dashboards">
            <div id="dashHeading">Dashboards&nbsp;</div>
			<div id="dashActions">
				<input id="createDashboardButton" type="image" src="images/add.png"></input>
				<input id="renameDashboardButton" type="image" src="images/rename.png"></input>
				<input id="removeDashboardButton" type="image" src="images/remove.png"></input>
				<input id="reorderDash" type="image" src="images/saveOrder.png"></input>
			</div>
			<p>
            <div id="allDash"></div>
			<p>
    </div>
	<p>
	<div id="presets">
		<div id="presetHeading">Presets&nbsp;</div>
		<div id="presetActions">
			<input id="renamePreset" type="image" src="images/rename.png"></input>
			<input id="removePreset" type="image" src="images/remove.png"></input>
			<input id="saveOrder" type="image" src="images/saveOrder.png"></input>
        </div>
		<p>
		<div id="allPresets"></div>
		<div id="presetsDlg"></div>
		<div id="renamePresetDlg"></div>
		<div id="removePresetDlg"></div>
	</div>
    <div id="activities">
		
		<h2>
            <div id="ht"><div class="loader"></div></div>
        </h2>
        <table class="tablesorter tablesorter-pager highlight" id="runs" cellspacing="0" summary="Running and hiking activities" style="display:none">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Distance&nbsp;&nbsp;</th>
                    <th>Time</th>
                    <th>Pace&nbsp;&nbsp;</th>
                    <th>Speed&nbsp;&nbsp;</th>
                    <th>Elevation est.</th>
                    <th>Actions</th>
                </tr>
            </thead>
			<tfoot>
				<div id="pagerMenu" style="display:none">
				<div class="pager">
					<nav class="left pagerOpt">
						Per page
						<a href="#">10</a> |
						<a id="defPage" href="#" class="current">20</a> |
						<a href="#">30</a> |
						<a href="#">50</a> |
						<a href="#">All</a>
					</nav>
					<nav class="right pagerOpt">
						Page
						<span class="prev">
							<img src="prev.png" />
						</span>
						<span class="pagecount"></span>
						<span class="next">
							<img src="next.png" />
						</span>
					</nav>
					<div id="pagerOut" class="pagerOpt"></div>
				</div>
				</div>
			</tfoot>
            <tbody />
        </table>
    </div>
	</div>
	<div id="sideBar">
		<button id="mTotalsBtn">Monthly totals</button>
		<button id="wTotalsBtn">Weekly totals</button>
		<button id="bestTotalsBtn">Best split times</button>
		<div id="overallWrap">
            <div id="titleTotals">
                <h2>Totals</h2>
            </div>
			<div id="overallLoader"></div>
            <table id="overall">
                <tbody></tbody>
            </table>
        </div>
		<div id="bestOfWrap">
            <div id="titleBest">
                <h2>Best</h2>
            </div>
			<div id="bestOfLoader"></div>
            <table id="bestOf">
                <tbody></tbody>
            </table>
        </div>
	</div>
	</div>
    <div id="editable"></div>
    <div id="removable"></div>
    <div id="details"></div>
    <div id="bestSplits"></div>
    <div id="mTotals"></div>
	<div id="wTotals"></div>
    <div id="dataHolder" />
    <div id="comparable">
        <div id="compareResults" />
    </div>
    <div id="infoDialog"></div>
    <div id="login" />
	<div id="rescanDialog"></div>
	<div id="typesDialog"></div>
	<div id="confirmDialogDash"></div>
	<div id="confirmDialogPresets"></div>
</body>

</html>