<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Comparison details</title>

    <link rel="stylesheet" href="bootstrap.min.css">
    <script src="bootstrap.min.js"></script>

    <link href="styleActivity.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.structure.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.theme.min.css" type="text/css" rel="stylesheet" />
    <link rel="icon" href="tab_icon.png">
    <script src="jquery-3.2.1.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="js/jquery.tablesorter.js"></script>
    <script src="js/jquery.tablesorter.widgets.js"></script>
    <script src="js/parsers/parser-ipv6.js"></script>
    <script src="js/jquery.metadata.js"></script>



    <script>
        function formatEleDiff(diff) {
            if (diff == 0) {
                return '0';
            }
            if (diff > 0) {
                return '<span class="green">+' + diff + '</span>';
            }
            return '<span class="red">' + diff + '</span>';
        }

        function round(point) {
            if (Math.abs(point - Math.round(point)) < 1e-3) {
                return Math.round(point);
            }
            return point;
        }

        function init(item, divName) {
            distr = item['speedDist'];
            tableHtml = '<span class="highlight"><table id="distTable"><thead><th>Range</th><th>Time</th><th>Distance</th><th>Gain</th><th>Loss</th></thead><tbody>';
            $.each(distr, function(i, diap) {
                tableHtml += '<tr><td><strong>' + diap['range'] + ' km/h</strong></td><td>' + diap['time'] + '</td><td>' + diap['dist'] + '</td><td><span class="green">' + diap['elePos'] + '</span></td><td><span class="red">' + diap['eleNeg'] + '</span></td></tr>';
            });
            tableHtml += '</tbody></table></span>';
            splits = item['splits']
            splitHtml = '<span class="heading-data"><h2>Splits</h2></span>' +
                '<span class="highlight"><table id="splitTable"><thead><th>Point(km)</th><th>Pace</th><th>Avg speed</th><th>Diff</th><th>Total time</th><th>Acc speed</th><th>Rel elev</th></thead><tbody>';
            collectHtml = "";
            $.each(splits, function(i, sp) {
                splitHtml += '<tr><td><strong>' + round(sp['total']) + '</strong></td><td><div id="spPace' + i + '">' + sp['pace'] + '</div></td><td>' + sp['speed'] + '</td><td><div id="spDiff' + i + '">' + formatEleDiff(sp['ele']) +
                    '</div></td><td><div id="spTotal' + i + '">' + sp['timeTotal'] +
                    '</div></td><td><div id="spAS' + i + '">' + sp['accumSpeed'] + '</div></td><td><div id="spAcc' + i + '">' + formatEleDiff(sp['accEle']) + '</div></td></tr>';
                collectHtml += '<div id="extsp' + i + '">' + formatEleDiff(sp['accElePos']) + '/' + formatEleDiff(-sp['accEleNeg']) + '</div>';
                collectHtml += '<div id="spElePos' + i + '">' + sp['accElePos'] + '</div><div id="spEleNeg' + i + '">' + sp['accEleNeg'] + '</div>';
            });
            $('#collect').html(collectHtml + '<div id="countSP">' + splits.length + '</div>');
            splitHtml += '</tbody></table></span>';
            var origData = item['origData'];
            var isMod = item['isModified'] == 'y';
            $('#' + divName).html('<table><tbody><tr><td>Name</td><td>' + decodeURIComponent(item['name']) + '</td></tr><tr><td>Type</td><td>' + item['type'] + '</td></tr><tr><td>Date</td><td>' + item['date'] + '</td></tr>' +
                '<tr><td>Distance</td><td>' +
                item['dist'] + (isMod ? '<em> / ' + origData['dist'] + '*</em>' : '') + '</td></tr><tr><td>Total time</td><td>' + item['timeTotal'] + (isMod ? '<em> / ' + origData['timeTotal'] + '*</em>' : '') +
                '</td></tr><tr><td>Elevation gain</td><td>' +
                '<span class="green">' + item['eleTotalPos'] + (isMod ? '<em> / ' + origData['eleTotalPos'] + '*</em>' : '') + '</span></td></tr><tr><td>Elevation loss</td><td>' + '<span class="red">' +
                item['eleTotalNeg'] + (isMod ? '<em> / ' + origData['eleTotalNeg'] + '*</em>' : '') + '</span></td></tr><tr><td>' +
                'Running|>9km/h| time</td><td>' + (isMod ? '<em>' : '') + item['timeRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running|>9km/h| distance</td><td>' + (isMod ? '<em>' : '') +
                item['distRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running|>9km/h| elevation gain</td><td>' +
                '<span class="green">' + (isMod ? '<em>' : '') + item['eleRunningPos'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Running|>9km/h| elevation loss</td><td>' +
                '<span class="red">' + (isMod ? '<em>' : '') + item['eleRunningNeg'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Rest time</td><td>' + (isMod ? '<em>' : '') + item['timeRest'] + (isMod ? '*</em>' : '') +
                '</td></tr><tr><td>Average speed</td><td>' + item['avgSpeed'] + (isMod ? '<em> / ' + origData['avgSpeed'] + '*</em>' : '') +
                '</td></tr><tr><td>Average pace</td><td>' + item['avgPace'] + (isMod ? '<em> / ' + origData['avgPace'] + '*</em>' : '') + '</td></tr></tbody></table>');
            $('#' + divName).append('<hr><span class="heading-data"><h2>Speed distribution</h2></span>' + tableHtml + '<hr>' + splitHtml);
            if (item['type'] != 'Running') {
                $('#toggle').prop('checked', true).change();
            }
        }

        $(document).ready(function() {
            $('#trace').button();
            $('#tres').button();
            $('#toggle').checkboxradio();
            $('#heading').html('<h1><strong>Comparison data</strong></h1><hr>');
            $.ajax({
                url: 'fa/TBD1',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
                        init(data, 'leftStats');
                    }
                }
            });
            $.ajax({
                url: 'fa/TBD2',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
                        init(data, 'rightStats');
                    }
                }
            });
        });
    </script>

</head>

<body>
    <div id="heading"></div>
    <div class="container-fluid">
        <div class="row-fluid">

            <div class="col-sm-3">
                <div id="leftStats"></div>
            </div>

            <div class="col-sm-6">
                <div id="mapHolder">
                    <div id="map"></div>
                    <button id="trace">Trace</button>
                    <button id="tres">Reset</button>
                    <label for="tSec">Simulation time(lower is faster)</label>
                    <input id="tSec" type="number" min="10" max="240" step="1" value="45"></input>
                    <label for="toggle">Toggle km markers</label>
                    <input type="checkbox" id="toggle" />
                </div>
            </div>

            <div class="col-sm-3">
                <div id="rightStats"></div>
            </div>

        </div>
    </div>
    <div style="display: none" id="collect"></div>

    <script>
        var marks1 = [];
		var marks2 = [];
		var perc1 = [];
		var times1 = [];
		var perc2 = [];
		var times2 = [];
        timerId = null;
		
		var itr1 = 0;
		var ind1 = 0;
		var ind2 = 0;
		
		var lineA;
		var lineB;
		
		function drawPath(map, data, isMain, lineColor, circleColor) {
			pref = isMain ? 'A' : 'B';
			coords = [];
			lats = data['lats'];
			lons = data['lons'];
			markers = data['markers'];
			var west = 200;
			var east = -200;
			var south = 90;
			var north = -90;
			$.each(lats, function(i, item) {
				coords.push({
					lat: item,
					lng: lons[i]
				});
				north = Math.max(north, lats[i]);
				south = Math.min(south, lats[i]);
				east = Math.max(east, lons[i]);
				west = Math.min(west, lons[i]);
			});
			var lineSymbol = {
				path: google.maps.SymbolPath.CIRCLE,
				scale: 6,
				strokeColor: circleColor
			};
			var runPath = new google.maps.Polyline({
				path: coords,
				geodesic: true,
				strokeColor: lineColor,
				strokeOpacity: 1.0,
				strokeWeight: 2,
				icons: [{
					icon: lineSymbol,
					offset: '0%'
				}]
			});
			if (isMain) {
				var md = Math.max(north - south, east - west);
				if (md < 0.006) {
					map.setZoom(17);
				} else if (md < 0.012) {
					map.setZoom(16);
				} else if (md < 0.03) {
					map.setZoom(15);
				} else if (md < 0.06) {
					map.setZoom(14);
				} else if (md < 0.11) {
					map.setZoom(13);
				} else if (md < 0.2) {
					map.setZoom(12);
				} else if (md < 0.4) {
					map.setZoom(11);
				}
				map.setCenter({
					lat: (south + north) / 2.0,
					lng: (east + west) / 2.0
				});
			}
			var mStart = new google.maps.Marker({
				position: {
					lat: lats[0],
					lng: lons[0]
				},
				map: map,
				label: {
					text: pref + ' Start',
					fontSize: "18px",
					fontWeight: 'bold'
				},
				icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|59f442'
			});
			var mEnd = new google.maps.Marker({
				position: {
					lat: lats[lats.length - 1],
					lng: lons[lons.length - 1]
				},
				map: map,
				label: {
					text: pref + ' End',
					fontSize: "18px",
					fontWeight: 'bold'
				},
				icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|e2093b'
			});
			mStart.setMap(map);
			mEnd.setMap(map);
			for (i = 0; i < markers.length; ++i) {
				var mark = new google.maps.Marker({
					position: {
						lat: lats[markers[i]],
						lng: lons[markers[i]]
					},
					label: {
						text: pref + (i + 1) + '',
						fontSize: "18px",
						fontWeight: 'bold',
						color: 'red'
					},
					icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|4286f4'
				});
				if (isMain) {
					marks1.push(mark);
				} else {
					marks2.push(mark);
				}
				if ($('#toggle').prop('checked')) {
					mark.setMap(map);
				}
			}
			$('#toggle').change(function() {
				arr = (isMain ? marks1 : marks2);
				if ($('#toggle').prop('checked')) {
					for (i = 0; i < arr.length; ++i) {
						arr[i].setMap(map);
					}
				} else {
					for (i = 0; i < arr.length; ++i) {
						arr[i].setMap(null);
					}
				}
			});
			runPath.setMap(map);
			if (isMain) {
				lineA = runPath;
				perc1 = data['perc'];
				times1 = data['times'];
			} else {
				lineB = runPath;
				perc2 = data['perc'];
				times2 = data['times'];
			}
		}

        function initMap() {
            var mapOptions = {
                center: {
                    lat: 42.7,
                    lng: 25
                },
                zoom: 10,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                    mapTypeId: ['roadmap', 'terrain']
                },
                mapTypeId: google.maps.MapTypeId.HYBRID
            };
            var map = new google.maps.Map(document.getElementById('map'), mapOptions);
            $.ajax({
                url: 'coords',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json',
                    'activity': 'TBD1',
					'perc': 'true'
                },
                statusCode: {
                    200: function(data) {
                        drawPath(map, data, true, '#cc3d20', '#5bba25');
                    }
                }
            });
			$.ajax({
                url: 'coords',
                method: 'POST',
                dataType: 'json',
                headers: {
                    'Content-Type': 'application/json',
                    'activity': 'TBD2',
					'perc': 'true'
                },
                statusCode: {
                    200: function(data) {
                        drawPath(map, data, false, '#2261b5', '#b7b521');
                    }
                }
            });
			$('#trace').click(function() {
				animateCircle();
			});
        }
		
		function getTSec() {
			var speed = $('#tSec').val();
            if (speed == null || speed == '' || speed == 'undefined') {
                speed = 45;
                $('#tSec').val('45');
            } else {
                speed = parseInt(speed);
            }
            if (speed > 240) {
                speed = 240;
                $('#tSec').val('240');
            }
            if (speed < 10) {
                speed = 10;
                $('#tSec').val('10');
            }
			return speed;
		}

        function animateCircle() {
			var totalIts = getTSec() * 20;
            var remIts = totalIts;
			var totalTime = times1[times1.length - 1];
			var remTimeCompB = 0;
			var fs = true;
			var secondaryIts = 0;
			var remSecondaryIts = 0;
			var secondaryTime = 0;
			var startSecTime = 0;
            var f = function() {
                if (remIts == 0) {
					if (ind2 < perc2.length) {
						if (fs) {
							fs = false;
							secondaryIts = ((times2[times2.length - 1] - times2[ind2]) / times2[ind2]) * totalIts;
							remSecondaryIts = secondaryIts;
							secondaryTime = times2[times2.length - 1] - times2[ind2];
							startSecTime = times2[ind2];
							alert('not comp ' + secondaryIts);
						}
						if (remSecondaryIts >= 0) {
							elapsedPerc = (secondaryIts - remSecondaryIts) / secondaryIts;
							while (ind2 < perc2.length) {
								cPerc = (times2[ind2] - startSecTime) / secondaryTime;
								if (cPerc >= elapsedPerc) {
									percS = perc2[ind2];
									break;
								}
								++ind2;
							}
							console.log("percs = " + percS);
							var iconsB = lineB.get('icons');
							iconsB[0].offset = percS + '%';
							lineB.set('icons', iconsB);
							--remSecondaryIts;
						}
					}
                    return;
                }
				elapsedPerc = (totalIts - remIts) / totalIts;
				--remIts;
				percA = 100;
                while (itr1 < times1.length) {
					timePerc = times1[itr1] / totalTime;
					if (timePerc >= elapsedPerc) {
						tprev = (itr1 > 0 ? times1[itr1 - 1] : 0);
						timePercPrev = tprev / totalTime;
						diff = timePerc - timePercPrev;
						coef = (diff > 0 ? (elapsedPerc - timePercPrev) / diff : 0);
						percPrev = (itr1 > 0 ? perc1[itr1 - 1] : 0);
						percA = percPrev + coef * (perc1[itr1] - percPrev);
						break;
					}
					++itr1;
				}
                var icons = lineA.get('icons');
                icons[0].offset = percA + '%';
                lineA.set('icons', icons);
				var tt = times1[times1.length - 1];
				while (ind1 < perc1.length) {
					if (perc1[ind1] >= percA) {
						percPrev = (ind1 > 0 ? perc1[ind1 - 1] : 0);
						diff = (perc1[ind1] - percPrev);
						coef = (diff > 0 ? (percA - percPrev) / diff : 0);
						timePrev = (ind1 > 0 ? times1[ind1 - 1] : 0);
						tt = timePrev + coef * (times1[ind1] - timePrev);
						break;
					}
					++ind1;
				}
				var percB = 100;
				while (ind2 < perc2.length) {
					if (times2[ind2] >= tt) {
						timePrev = (ind2 > 0 ? times2[ind2 - 1] : 0);
						diff = times2[ind2] - timePrev;
						coef = diff > 0 ? (tt - timePrev) / diff : 0;
						percPrev = (ind2 > 0 ? perc2[ind2 - 1] : 0)
						percB = percPrev + coef * (perc2[ind2] - percPrev);
						break;
					}
					++ind2;
				}
				console.log(ind2 + ' ' + percB + " " + times2[1000]);
				var iconsB = lineB.get('icons');
				iconsB[0].offset = percB + '%';
                lineB.set('icons', iconsB);
            };
            timerId = setInterval(f, 50);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCC4nPG5F3bF4gXe9yc4-0cOQH4oGKqWI&callback=initMap"></script>
</body>

</html>