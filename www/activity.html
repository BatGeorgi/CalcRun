<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Activity details</title>
    <link href="style.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.structure.min.css" type="text/css" rel="stylesheet" />
    <link href="jquery-ui.theme.min.css" type="text/css" rel="stylesheet" />
    <link rel="icon" href="tab_icon.png">
    <script src="jquery-3.2.1.js"></script>
    <script src="jquery-ui.min.js"></script>
    <script src="js/jquery.tablesorter.js"></script>
    <script src="js/jquery.tablesorter.widgets.js"></script>
    <script src="js/parsers/parser-ipv6.js"></script>
    <script src="js/jquery.metadata.js"></script>
	
	<script>
	
		function formatEleDiff(diff) {
            if (diff == 0) {
                return '0';
            }
            if (diff > 0) {
                return '<span class="green">+' + diff + '</span>';
            }
            return '<span class="red">' + diff + '</span>';
        }
	
		function round(point) {
            if (Math.abs(point - Math.round(point)) < 1e-3) {
                return Math.round(point);
            }
            return point;
        }
		
		function init(item) {
			$('#heading').html('<h1><strong>' + decodeURIComponent(item['name']) + ' ' + item['type'] + ' ' + item['date'] + '</strong></h1><hr>');
			distr = item['speedDist'];
            tableHtml = '<span class="highlight"><table style="margin: auto;"><thead><th>Range</th><th>Time</th><th>Distance</th><th>Gain</th><th>Loss</th></thead><tbody>';
            $.each(distr, function(i, diap) {
                tableHtml += '<tr><td><strong>' + diap['range'] + ' km/h</strong></td><td>' + diap['time'] + '</td><td>' + diap['dist'] + '</td><td><span class="green">' + diap['elePos'] + '</span></td><td><span class="red">' + diap['eleNeg'] + '</span></td></tr>';
            });
            tableHtml += '</tbody></table></span>';
            splits = item['splits']
            splitHtml = '<span style="color:#1c9e45"><h2>Splits</h2></span>' +
				'<span class="highlight"><table style="margin: auto;"><thead><th>Point(km)</th><th>Pace</th><th>Avg speed</th><th>Diff</th><th>Total time</th><th>Acc speed</th><th>Acc diff</th></thead><tbody>';
            $.each(splits, function(i, sp) {
                splitHtml += '<tr><td><strong>' + round(sp['total']) + '</strong></td><td>' + sp['pace'] + '</td><td>' + sp['speed'] + '</td><td>' + formatEleDiff(sp['ele']) + '</td><td>' + sp['timeTotal'] +
				'</td><td>' + sp['accumSpeed'] + '</td><td>' + formatEleDiff(sp['accEle']) + '</td></tr>';
            });
            splitHtml += '</tbody></table></span>';
            var origData = item['origData'];
			var isMod = item['isModified'] == 'y';
            $('#mainstats').html((isMod ? '<em><h4>*This activity has been modified</h4></em>' : '' ) + '<table style="margin: auto;"><tbody><tr><td>Distance</td><td>'
				+ item['dist'] + (isMod ? '<em> / ' + origData['dist'] + '*</em>': '') + '</td></tr><tr><td>Total time</td><td>' + item['timeTotal'] + (isMod ? '<em> / ' + origData['timeTotal'] + '*</em>' : '') + 
				'</td></tr><tr><td>Elevation gain(m)</td><td>' +
                '<span class="green">' + item['eleTotalPos'] + (isMod ? '<em> / ' + origData['eleTotalPos'] + '*</em>' : '') + '</span></td></tr><tr><td>Elevation loss(m)</td><td>' + '<span class="red">' +
				item['eleTotalNeg'] + (isMod ? '<em> / ' + origData['eleTotalNeg'] + '*</em>' : '') + '</span></td></tr><tr><td>' +
                'Running time(>9km/h)</td><td>' + (isMod ? '<em>' : '') + item['timeRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running distance</td><td>' + (isMod ? '<em>' : '') +
				item['distRunning'] + (isMod ? '*</em>' : '') + '</td></tr><tr><td>Running elevation gain(m)</td><td>' +
				'<span class="green">' + (isMod ? '<em>' : '') + item['eleRunningPos'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Running elevation loss(m)</td><td>' +
                '<span class="red">' + (isMod ? '<em>' : '') + item['eleRunningNeg'] + (isMod ? '*</em>' : '') + '</span></td></tr><tr><td>Rest time</td><td>' + (isMod ? '<em>' : '' ) + item['timeRest'] + (isMod ? '*</em>':  '') +
				'</td></tr><tr><td>Average speed(km/h)</td><td>' + item['avgSpeed'] + (isMod ? '<em> / ' + origData['avgSpeed'] + '*</em>' : '') +
				'</td></tr><tr><td>Average pace(min/km)</td><td>' + item['avgPace'] + (isMod ? '<em> / ' + origData['avgPace'] + '*</em>' : '') + '</td></tr></tbody></table><hr>' +
				 splitHtml);
			$('#splits').html('<span style="color:#1c9e45"><h2>Speed distribution</h2></span>' + tableHtml);
			if (item['type'] != 'Running') {
				$("#toggle").prop('checked', true).change();
			}
		}
		
		$(document).ready(function() {
			$("#trace").button();
			$("#toggle").checkboxradio();
			$.ajax({
                url: 'TBD',
                method: 'POST',
                dataType: 'json',
				headers: {
                    'Content-Type': 'application/json'
                },
                statusCode: {
                    200: function(data) {
							document.title = decodeURIComponent(data['name']);
							init(data);
                        }
                }
			});
		});
	</script>

</head>

<body>
	<div id="heading" style="color: #1c9e45;"></div>
	<div id="mainstats" style="float: left;text-align:center;font-size: 120%;width: $(window).width() * 0.4">
	</div>
	<div id="splits" style="float: right;text-align:center;"></div>
	<div id="mapHolder">
		<div id="map" style="margin:auto;height:750px;width: $(window).width() * 0.6">
		</div>
		<label for="toggle" style="margin-left: 20%; margin-top: 10px">Toggle km markers</label>
		<input type="checkbox" id="toggle" />
	</div>
	</div>
	
	<script>

		var marks = [];

		function initMap() {
			var mapOptions = {
				center: {lat: 42.7, lng: 25},
				zoom:9,
				mapTypeControl: true,
				mapTypeControlOptions: {
					style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
					mapTypeId: ['roadmap', 'terrain']
				},
				mapTypeId: google.maps.MapTypeId.HYBRID
			};
			var map = new google.maps.Map(document.getElementById('map'), mapOptions);
			$.ajax({
                url: 'coords',
                method: 'POST',
                dataType: 'json',
				headers: {
                    'Content-Type': 'application/json',
					'activity': 'TBD'
                },
                statusCode: {
                    200: function(data) {
						coords = [];
						lats = data['lats'];
						lons = data['lons'];
						markers = data['markers'];
						$.each(lats, function(i, item) {
							coords.push({lat: item, lng: lons[i]});
						});
						var runPath = new google.maps.Polyline({
							path: coords,
							geodesic: true,
							strokeColor: '#FF0000',
							strokeOpacity: 1.0,
							strokeWeight: 2
						});
						map.setCenter({lat: lats[0], lng: lons[0]});
						map.setZoom(13);
						var mStart = new google.maps.Marker({
							position: {lat: lats[0], lng: lons[0]},
							map: map,
							label: {
								text: 'Start',
								fontSize: "18px",
								fontWeight: 'bold'
							},
							icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|59f442'
						});
						var mEnd = new google.maps.Marker({
							position: {lat: lats[lats.length - 1], lng: lons[lons.length - 1]},
							map: map,
							label: {
								text: 'End',
								fontSize: "18px",
								fontWeight: 'bold'
							},
							icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|e2093b'
						});
						mStart.setMap(map);
						mEnd.setMap(map);
						for (i = 0; i < markers.length; ++i) {
							var mark = new google.maps.Marker({
								position: {lat: lats[markers[i]], lng: lons[markers[i]]},
								label: {
									text: (i + 1) + ' km',
									fontSize: "18px",
									fontWeight: 'bold',
									color: 'red'
								},
								icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|4286f4'
							});
							marks.push(mark);
							if ($("#toggle").prop('checked')) {
								mark.setMap(map);
							}
						}
						$("#toggle").change(function() {
							if ($("#toggle").prop('checked')) {
								for (i = 0; i < marks.length; ++i) {
									marks[i].setMap(map);
								}
							} else {
								for (i = 0; i < marks.length; ++i) {
									marks[i].setMap(null);
								}
							}
						});
						runPath.setMap(map);
                    }
                }
			});
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDCC4nPG5F3bF4gXe9yc4-0cOQH4oGKqWI&callback=initMap"></script>
</body>

</html>