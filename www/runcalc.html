<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>Running stats</title>
<link href="style.css" type="text/css" rel="stylesheet" />
<link href="jquery-ui.min.css" type="text/css" rel="stylesheet" />
<link href="jquery-ui.structure.min.css" type="text/css" rel="stylesheet" />
<link href="jquery-ui.theme.min.css" type="text/css" rel="stylesheet" />
<script src="jquery-3.2.1.js"></script>
<script src="jquery-ui.min.js"></script>
<script>
function detailsDialog(id, html, name) {
	$('#details').append('<div id="' + id + '"></div>');
	$('#' + id).dialog({
    autoOpen : false, modal : false, show : "blind", hide : "blind", buttons: {
            "Close": function() {
                $(this).dialog("close");
            }
        },
        width: 600,
        height: 800,
		create: function (event) {
            $(event.target).parent().css({ 'position': 'fixed', "left": 50, "top": 150 });
          }
  });
  $('#' + id).html(html);
  $('#' + id).dialog('option', 'title', 'Details ' + name);
  $('#' + id).dialog('open');
}
function getOption(val, current) {
	return '<option value="' + val + '"' + (current == val ? ' selected>' : '>') + val + '</option>';
}
function colorDiff(diff) {
	c = diff.charAt(0);
	if (c == '+') {
		return '<span class="red">' + diff + '</span>';
	}
	if (c == '-') {
		return '<span class="green">' + diff + '</span>';
	}
	return diff;
}
function valTime(time) {
	res = time.split(":");
	if (res.length == 2) {
		return 60 * parseInt(res[0]) + parseInt(res[1]);
	}
	return 3600 * parseInt(res[0]) + 60 * parseInt(res[1]) + parseInt(res[2]);
}
function comp(t1, t2, tt) {
	if (t1 < t2) {
		return '<span class="green">' + tt + '</span>';
	}
	if (t1 == t2) {
		return tt;
	}
	return '<span class="red">' + tt + '</span>';
}
function comp2(t1, t2) {
	return comp(parseFloat(t2.replace(',', '.')), parseFloat(t1.replace(',', '.')), t1);
}
function colorDiff1(tt1, tt2) {
	t1 = valTime(tt1);
	t2 = valTime(tt2);
	return comp(t1, t2, tt1);
}
function formatEle(gain, loss) {
	res = '-';
	if (gain > 0 && loss > 0) {
		res = '+' + gain + '/-' + loss;
	} else if (gain > 0) {
		res = '+' + gain;
	} else if (loss > 0) {
		res = '-' + loss;
	}
	return res;
}
function initDialogs() {
	$("#editable").dialog({
    autoOpen : false, modal : true, show : "blind", hide : "blind", buttons: {
            "Save": function() {
				$.ajax({
					url: 'editActivity',
					headers: {
						'Content-Type':'application/json',
						'File': $("#editable").attr('genby'),
						'Name': $('#chooseName').val(),
						'Type': $('#chooseType').val(),
						'Password': $('#pass').val()
					},
					method: 'POST',
					dataType: 'json',
					statusCode: {
						200: function (xhr) {
							$('#' + $("#editable").attr('refname')).text($('#chooseName').val());
							$('#' + $("#editable").attr('reftype')).text($('#chooseType').val());
						},
						401: function (xhr) {
							alert('DGD BOKLIK!');
						},
						400: function (xhr) {
							alert('Empty name!');
						} 
					}
				});
                $(this).dialog("close");
            }
        },
        width: 400,
        height: 300,
		create: function (event) {
            $(event.target).parent().css({ 'position': 'fixed', "left": 70, "top": 140 });
        }
  });
  $('#comparable').dialog({
    autoOpen : false, modal : true, show : "blind", hide : "blind", buttons: {
            "Compare": function() {
                $.ajax({
					url: 'compare',
					method: 'POST',
					dataType: 'json',
					headers: {
						'Content-Type':'application/json',
						'file1': $('#comparable').attr('file1'),
						'file2': $('#selectComp').find(':selected').attr('genby')
					},
					statusCode: {
						200: function (data) {
							index = $("#selectComp option:selected").index() + 1;
							general = data['general'];
							times = data['times'];
							tt = '';
							$.each(times, function(i, sp) {
								tt += '<tr><td>' + sp['point'] + ' km</td><td>' + colorDiff1(sp['time1'], sp['time2']) + '</td><td>' + colorDiff1(sp['time2'], sp['time1']) + '</td><td>' + colorDiff(sp['currentDiff']) + '</td><td>' + colorDiff(sp['totalDiff']) + '</td></tr>';
							});
							$('#comparable').html($('#comparable').attr('opts'));
							$('#selectComp :nth-child(' + index + ')').prop('selected', true);
							$('#comparable').append('<h2>General</h2><table><thead><th></th><th>' + general['name1'] + ' ' + general['date1'] + '</th><th>' + general['name2'] + ' ' + general['date2'] + '</th></thead><tbody>' +
							'<tr><td>Date</td><td>' + general['date1'] + '</td><td>' + general['date2'] + '</td></tr><tr><td>Distance</td><td>' + comp2(general['dist1'], general['dist2']) + '</td><td>' + comp2(general['dist2'], general['dist1'])  + '</td></tr>' +
							'<tr><td>Time</td><td>' + colorDiff1(general['time1'], general['time2']) + '</td><td>' + colorDiff1(general['time2'], general['time1']) + '</td></tr>' +
							'<tr><td>Speed</td><td>' + comp2(general['speed1'], general['speed2']) + '</td><td>' + comp2(general['speed2'], general['speed1']) + '</td></tr><tr><td>Elev gain</td><td>' + general['elePos1'] + '</td><td>' + general['elePos2'] + '</td></tr>' +
							'<tr><td>Elev loss</td><td>' + general['eleNeg1'] + '</td><td>' + general['eleNeg2'] + '</td></tr></tbody></table>');
							$('#comparable').append('<span class="highlight"><h2>Splits</h2><table><thead><th>Point</th><th>' + general['name1'] + ' ' + general['date1'] + '</th><th>' + general['name2'] + ' ' + general['date2'] + '</th><th>Segment diff</th><th>Total diff</th></thead><tbody>' + tt + '</tbody></table></span>');
						},
						400: function (xhr) {
							alert('Activities may be removed :(');
						}
					}
				});
            },
			"Close": function() {
				$(this).dialog("close");
			}
        },
        width: 800,
        height: 800,
		create: function (event) {
            $(event.target).parent().css({ 'position': 'fixed', "left": 50, "top": 150 });
        }
  });
  $('#rescanForm').dialog({
	autoOpen : false, modal : true, show : "blind", hide : "blind", buttons: {
			"Rescan": function() {
                $.ajax({
					url: 'rescanActivities',
					method: 'POST',
					dataType: 'json',
					headers: {
						'Content-Type': 'application/json',
						'Password': $('#passRescan').val()
					},
					statusCode: {
						200: function (data) {
							loadActivities();
						},
						401: function (xhr) {
							alert('DGD BOKLIK!');
						}
					}
				});
				$(this).dialog("close");
            },
            "Close": function() {
                $(this).dialog("close");
            }
        },
        width: 400,
        height: 200,
		create: function (event) {
            $(event.target).parent().css({ 'position': 'fixed', "left": 50, "top": 150 });
        }
  });
  $('#addForm').dialog({
	autoOpen : false, modal : true, show : "blind", hide : "blind", buttons: {
			"Add": function() {
				alert('Not implemented yet!');
            },
            "Close": function() {
                $(this).dialog("close");
            }
        },
        width: 500,
        height: 300,
		create: function (event) {
            $(event.target).parent().css({ 'position': 'fixed', "left": 50, "top": 150 });
        }
  });
}
function loadActivities() {
$.post('loadActivities', function( data ) {
  itemsDS = [];
  editDS = [];
  compareDS = [];
  $('#dataHolder').html('');
  all = data['activities'];
  runsHtml = '<h2>Activities</h2><table id="runs" cellspacing="0" summary="Running and hiking activities">';
  runsHtml += '<thead><tr><th>#</th><th>Date</th><th>Name</th><th>Type</th><th>Distance</th><th>Time</th><th>Pace</th><th>Speed</th><th>Elevation est.</th><th>Actions</th></tr></thead>';
  $.each(all, function(i, item) {
	runsHtml += '<tr><td>' + (i + 1) + '</td><td><div id="date' + i + '">' + item['date'] + '</div></td><td><div class="runitem" id="item' + i + '">' + item['name'] + '</div></td><td><div id="type' + i + '">' + item['type'] + '</div></td><td>'
	    + item['dist'] + ' km</td><td>' + item['timeTotal'] + '</td><td>' + item['avgPace'] + ' min/km</td><td>' + item['avgSpeed'] + ' km/h</td>'
		+ '<td>' + formatEle(item['eleTotalPos'], item['eleTotalNeg']) + '</td>'
		+ '<td><div id="edit' + i + '" class="ui-icon ui-icon-pencil ui-state-hover runitem"></div>'
		+ '<div id="compare' + i + '" class="ui-icon ui-icon-arrowthick-2-e-w ui-state-hover runitem"></div></td></tr>';
	id = "data" + i;
	$('#dataHolder').append('<div style="display: none;" id="data' + i + '"></div>');
	distr = item['speedDist'];
	tableHtml = '<span class="highlight"><table><thead><th>Range</th><th>Time</th><th>Distance</th><th>Gain</th><th>Loss</th></thead><tbody>';
	$.each(distr, function(i, diap) {
		tableHtml += '<tr><td>' + diap['range'] + ' km/h</td><td>' + diap['time']  + '</td><td>' + diap['dist'] + ' km</td><td>' + diap['elePos']  +  ' m</td><td>' + diap['eleNeg']  + ' m</td></tr>';
	});
	tableHtml += '</tbody></table></span>';
	splits = item['splits'];
	splitHtml = '<span class="highlight"><table><thead><th>Point</th><th>Pace</th><th>Speed</th><th>Diff</th></thead><tbody>';
	$.each(splits, function(i, sp) {
		splitHtml += '<tr><td>' + sp['total'] + ' km</td><td>' + sp['pace'] + ' min/km</td><td>' + sp['speed'] + ' km/h</td><td>' + sp['ele'] + ' m</td></tr>';
	});
	splitHtml += '</tbody></table></span>';
	linkHtml = '';
	if (item.hasOwnProperty('garminLink')) {
		linkHtml = '</ul><a href="' + item['garminLink'] + '" target="_blank">Garmin Connect</a><ul>';
	}
	itemsDS.push(function() {
	detailsDialog("details" + i, $('#data' + i).html(), $('#item' + i).text());
	});
	$('#' + id).append('<ul><li>On ' + item['date'] + '</li><li>Distance ' + item['dist'] + ' km</li><li>Total time ' + item['timeTotal'] + '</li><li>Elevation gain ' + item['eleTotalPos'] + ' m</li><li>Elevation loss ' + item['eleTotalNeg'] + ' m</li>' +
		'<li>Running(>=9.0km/h) time ' + item['timeRunning'] + '</li><li>Running distance ' + item['distRunning'] + ' km</li><li>Running elevation gain ' + item['eleRunningPos'] + ' m</li><li>Running elevation loss ' + item['eleRunningNeg'] +
		' m</li><li>Rest time ' + item['timeRest'] + '</li><li>Average speed ' + item['avgSpeed'] + ' km/h</li><li>Average pace ' + item['avgPace'] + ' min/km</li>' + linkHtml + '<li>Speed distribution' +
		'</li>' + tableHtml + '</li><li>Splits</li>' + splitHtml + '</ul>');
	editDS.push(function() {
		type = $('#type' + i).text();
		$("#editable").html('<table><tbody><tr><td>Name </td><td><input type="text" id="chooseName" value="' + $('#item' + i).text() + '"/></td></tr><tr><td>Type </td><td><select id="chooseType">' + getOption("Running", type) + getOption("Trail", type) +
			getOption('Hiking', type) + getOption('Walking', type) + getOption('Other', type) + '</select></td></tr><tr><td>Password </td><td><input type="password" id="pass"/></td></tr></tbody></table>');
		$("#editable").dialog('option', 'title', 'Edit #' + + (i + 1) + ' ' + $('#item' + i).text() + ' ' + $('#date' + i).text());
		$("#editable").attr('genby', item['genby']);
		$("#editable").attr('refname', 'item' + i);
		$("#editable").attr('reftype', 'type' + i);
		$("#editable").dialog('open');
	});
	compareDS.push(function() {
		$('#comparable').dialog('option', 'title', 'Compare #' + (i + 1) + ' ' + $('#item' + i).text() + ' ' + $('#date' + i).text());
		opts = '';
		$.each(all, function(i, item2) {
			opts += '<option genby="' + item2['genby']  + '" value="#' + (i + 1) + ' ' + $('#item' + i).text() + '">#' + (i + 1) + ' ' + $('#item' + i).text() + ' ' + $('#date' + i).text() + '</option>';
		});
		$('#comparable').html('Compare with <select id="selectComp">' + opts + '</select>');
		$('#comparable').attr('opts', 'Compare with <select id="selectComp">' + opts + '</select>');
		$('#comparable').attr('file1', item['genby']);
		$('#comparable').dialog('open');
	});
  });
  runsHtml += '</table>';
  $('#activities').html(runsHtml);
  for (i = 0; i < itemsDS.length; ++i) {
	$('#item' + i).click(itemsDS[i]);
  }
  for (i = 0; i < editDS.length; ++i) {
	$('#edit' + i).click(editDS[i]);
  }
  for (i = 0; i < compareDS.length; ++i) {
	$('#compare' + i).click(compareDS[i]);
  }
  $('#addButton').click(function() {
	$('#addForm').dialog('option', 'title', 'Add activity');
	$('#addForm').html('<table><tr><td>File </td><td><form id="addActivity" method="post" enctype="multipart/form-data" action="/addActivity" target="#"><input type="file" name="gpxIn"/></form></td></tr><tr><td>Password </td><td><input type="password" id="passRescan"/></td></tr></table>');
	$('#addForm').dialog('open');
  });
  $('#rescanButton').click(function() {
	$('#rescanForm').dialog('option', 'title', 'Rescan activities');
	$('#rescanForm').html('Password <input type="password" id="passRescan"/>');
	$('#rescanForm').dialog('open');
  });
});
}
function loadAll() {
	initDialogs();
	loadActivities();
}
</script>
</head>
<body onload = "loadAll();">
<div id = "heading">
	<H1><strong>Running stats</strong></H1> 
</div>
<input id="addButton" type="image" src="button-dark-plus-icon.png" width="40" height="40"/>
<input id="rescanButton" type="image" src="button_blue_rescan.png" width="40" height="40"/>
<div id = "activities" class="highlight" />
<div id = "editable" />
<div id = "comparable" />
<div id = "details" />
<div id = "addForm" />
<div id = "rescanForm" />
<div id = "dataHolder" />
</body>
</html>